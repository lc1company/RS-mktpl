<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.8/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.10.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs/plugin/isBetween.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <title>HelpiFy</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow-x: hidden;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            background: linear-gradient(135deg, #1c90aa, #2193b0);
            /* Gradiente semelhante ao botão */
            color: #fff;
            width: 100%;
            position: fixed;
            bottom: 0;
            left: 0;
            border-top: 1px solid #ccc;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-family: 'Arial', sans-serif;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            font-size: 0.9em;
            perspective: 1000px;
            position: relative;
        }

        .tab:hover {
            background: linear-gradient(135deg, #6dd5ed, #2193b0);
            /* Gradiente invertido para efeito de hover */
            box-shadow: 0 0 15px rgba(33, 147, 176, 0.5);
            /* Sombra luminosa no hover */
            transform: translateY(-3px);
        }

        .tab i {
            display: block;
            font-size: 1.5em;
            margin-bottom: 5px;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .tab span {
            font-size: 0.8em;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .tab:active {
            transform: scale(0.98);
        }

        .tab:active i,
        .tab:active span {
            transform: translateZ(20px);
        }

        .tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: #fff;
            /* Cor do foco */
            transition: width 0.4s ease, left 0.4s ease;
        }

        .tab:hover::before {
            width: 100%;
            left: 0;
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        .timeline {
            list-style: none;
            padding: 0;
        }

        .timeline-item {
            position: relative;
            border-bottom: 1px solid #ccc;
            padding: 10px 0;
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        #formPublicacao {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: nowrap;
        }

        #inputMensagem {
            flex: 1;
            padding: 10px;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-left: auto;
            margin-right: auto;
        }

        #inputImagem {
            display: none;
        }

        #btnEscolherArquivo {
            background-color: #007bff;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
            margin-left: 2%;
            margin-right: 2%;
        }

        #btnEscolherArquivo:hover {
            background-color: #0056b3;
        }

        #formPublicacao input[type="file"] {
            margin-bottom: 10px;
        }

        .publicacao-img {
            max-width: 95%;
            max-height: 40%;
            object-fit: cover;
        }

        #btnEscolherFotoPerfil {
            background-color: #007bff;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
            margin-bottom: 10px;
            margin-left: auto;
            margin-right: auto;
        }

        #btnEscolherFotoPerfil:hover {
            background-color: #0056b3;
        }

        #userProfilePicture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin-left: auto;
            margin-right: auto;
            object-fit: cover;
        }

        /* Estilos para os botões de like, dislike e comentários */
        .timeline-item button {
            background-color: #007bff;
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            margin-bottom: 2%;
            margin-top: 2%;
            transition: background-color 0.3s ease;
        }

        .timeline-item button:hover {
            background-color: #0056b3;
        }

        /* Estilos para o contêiner de comentários */
        .comments-container {
            position: absolute;
            top: calc(100% + 10px);
            left: 0;
            width: 100%;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .comments-container p {
            margin-bottom: 5px;
        }

        .comments-container textarea {
            width: calc(100% - 20px);
            height: 100px;
            padding: 5px;
            margin-top: 5px;
            border-radius: 4px;
            resize: none;
        }

        .comments-container button {
            background-color: #007bff;
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .comments-container button:hover {
            background-color: #0056b3;
        }

        footer {
            background-color: #f8f8f8;
            color: #333;
            text-align: center;
            padding: 2em 1em;
            position: relative;
            bottom: 0;
            width: 100%;
            margin-bottom: 7%;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            font-family: 'Arial', sans-serif;
            font-size: 13px;
        }

        footer p {
            margin: 0;
            font-size: 1em;
            color: #666;
        }

        footer nav {
            margin-top: 1em;
        }

        footer nav a {
            color: #0056b3;
            text-decoration: none;
            margin: 0 1em;
            font-size: 0.9em;
            transition: color 0.3s ease;
        }

        footer nav a:hover {
            color: #003f8a;
        }

        footer nav a:active {
            color: #002a5d;
        }

        /* Modal Container */
        .user-profile-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease-out;
        }

        /* Modal Content */
        .user-profile-content {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            color: #333;
            text-align: center;
            position: relative;
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.5s ease-out;
        }

        /* Close Button */
        .close-button {
            background-color: #007BFF;
            color: #fff;
            font-size: 18px;
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }

        .close-button:hover {
            background-color: #0056b3;
        }

        /* User Profile Picture */
        #userProfilePicturePopUp {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }

        /* User Name */
        #userProfileName {
            font-size: 24px;
            margin-bottom: 20px;
        }

        /* Ads Grid */
        .user-ads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Ad Item */
        .ad-item {
            background-color: #fff;
            color: #333;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
            position: relative;
            text-align: left;
            cursor: pointer;
        }

        .ad-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        /* Ad Image */
        .ad-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid #ddd;
        }

        /* Ad Details */
        .ad-details {
            padding: 10px;
        }

        .ad-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }

        .ad-description {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }

        .ad-price {
            font-size: 16px;
            color: #007BFF;
            margin: 5px 0;
        }

        /* WhatsApp Button */
        .whatsapp-button {
            background-color: #25D366;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .whatsapp-button:hover {
            background-color: #1DA851;
        }

        .whatsapp-button i {
            margin-right: 8px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
            }

            to {
                transform: translateY(0);
            }
        }

        #formPublicacao {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: block;
        }

        #formPublicacao input,
        #formPublicacao select,
        #formPublicacao button {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        #formPublicacao input:focus,
        #formPublicacao select:focus {
            border-color: #007bff;
            outline: none;
        }

        #formPublicacao button {
            background-color: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: bold;
            text-transform: uppercase;
        }

        #formPublicacao button:hover {
            background-color: #0056b3;
        }

        #formPublicacao .upload-button {
            background-color: #6c757d;
            color: #fff;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #formPublicacao .upload-button:hover {
            background-color: #5a6268;
        }

        #formPublicacao .form-group {
            margin-bottom: 15px;
        }

        #formPublicacao .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        #formPublicacao input[type="file"] {
            display: none;
        }

        .notification-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .notification-item .user-info {
            display: flex;
            flex-direction: column;
        }

        .notification-item .user-info span {
            font-weight: bold;
        }

        .notification-item .notification-text {
            margin-left: 10px;
        }

        /* Reset básico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .sign-out-btn {
            background-color: rgb(255, 0, 0);
            color: #fff;
            font-size: 17px;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .sign-out-btn:hover {
            background-color: #cc0000;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Estilos principais */
        #chatModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        #chatContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 800px;
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            height: 80%;
            overflow: hidden;
        }

        #chatHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #003366;
            color: #fff;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        #chatMessages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #chatInputContainer {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: #003366;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        #chatInput {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 20px;
            margin-right: 10px;
            outline: none;
            background-color: #fff;
            color: #000;
        }

        button {
            background-color: #0066cc;
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #005bb5;
        }

        /* Estilos de mensagens */
        .message-container {
            display: flex;
            align-items: flex-start;
            max-width: 80%;
            padding: 10px;
            border-radius: 15px;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background-color: #fff;
            animation: fadeIn 0.5s ease forwards;
        }

        .message-container.me {
            align-self: flex-end;
            background-color: #0066cc;
            color: #fff;
        }

        .message-container.me::after {
            content: "";
            position: absolute;
            top: 10px;
            right: -10px;
            border-width: 10px;
            border-style: solid;
            border-color: #0066cc transparent transparent transparent;
        }

        .message-container.their {
            align-self: flex-start;
            background-color: #fff;
            color: #000;
        }

        .message-container.their::after {
            content: "";
            position: absolute;
            top: 10px;
            left: -10px;
            border-width: 10px;
            border-style: solid;
            border-color: #fff transparent transparent transparent;
        }

        .message-content {
            max-width: 100%;
            margin-left: 10px;
        }

        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 0.75em;
            color: #aaa;
            margin-top: 5px;
        }

        /* Estilos de imagem de perfil */
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
        }

        .chat-title-content .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid #fff;
        }

        .chat-title-names {
            display: flex;
            align-items: center;
        }

        /* Animações */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification-counter {
            position: absolute;
            top: 5px;
            right: 15px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .skeleton {
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .skeleton-text {
            width: 80%;
            height: 16px;
            background-color: #ddd;
            margin: 10px 0;
        }

        .skeleton-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #ddd;
            margin-right: 15px;
        }

        .skeleton-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .skeleton-full {
            width: 100%;
            height: 200px;
            background-color: #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }


        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.9));
            padding-bottom: 20%;
            margin-bottom: 22%;
            backdrop-filter: blur(10px);
            /* Desfocar fundo para um efeito futurista */
            animation: fadeIn 0.5s ease;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.9);
            margin: 0 auto;
            padding: 30px;
            border: 1px solid #ddd;
            width: 90%;
            max-width: 1280px;
            border-radius: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            position: relative;
            max-height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            animation: slideUp 0.4s ease-out;
            /* Animação de entrada */
        }

        #modalDetalhes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            overflow: auto;
            z-index: 1000;
        }

        /* Carrossel de Imagens */
        .imagens-adicionais {
            display: flex;
            position: relative;
            overflow-x: auto;
            white-space: nowrap;
            position: relative;
            margin-top: -1px;
            /* Ajuste conforme a altura da imagem principal */
            z-index: 1;
        }

        /* Imagem adicional */
        .imagem-adicional {
            width: 100px;
            height: 100px;
            object-fit: cover;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 15px;
        }

        /* Container da imagem adicional */
        .imagem-container {
            position: relative;
            display: inline-block;
            margin-right: 10px;
        }

        .imagem-adicional:hover {
            filter: brightness(1.2);
            /* Brilho ao passar o mouse */
        }

        /* Botão de Tela Cheia */
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            padding: 8px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-btn:hover {
            background-color: rgba(0, 0, 0, 0.9);
        }

        /* Imagem em Tela Cheia */
        .imagem-fullscreen {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            cursor: pointer;
            animation: fadeIn 0.4s ease;
        }

        .imagem-fullscreen img {
            max-width: 85%;
            max-height: 85%;
            object-fit: contain;
            border-radius: 16px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            font-size: 2rem;
            padding: 10px;
            cursor: pointer;
            z-index: 1001;
        }

        .nav-btn.left {
            left: 20px;
            /* Botão da esquerda */
        }

        .nav-btn.right {
            right: 20px;
            /* Botão da direita */
        }

        .nav-btn:hover {
            background-color: rgba(0, 0, 0, 0.8);
            /* Efeito ao passar o mouse */
        }

        /* Detalhes do Anúncio */
        #detalhesAnuncio {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal-titulo {
            color: #222;
            font-size: 28px;
            margin-top: 20px;
            background: linear-gradient(90deg, #f0f, #0ff);
            -webkit-background-clip: text;
            /* Para navegadores baseados no WebKit */
            background-clip: text;
            /* Para outros navegadores */
            -webkit-text-fill-color: transparent;
            /* Mantém o texto transparente para o gradiente aparecer */
        }

        .info-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 5px;
        }

        .info-adicional {
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 15px;
            background-color: rgba(245, 245, 245, 0.9);
            width: 100%;
            max-width: 900px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            font-size: 16px;
            color: #333;
            transition: all 0.3s ease;
        }

        .info-adicional:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .info-descricao {
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            background: #f4f4f4;
            border-radius: 5px;
        }

        /* Imagem Principal */
        .imagem-principal {
            width: 100%;
            height: auto;
            border-radius: 16px;
            margin-top: 20px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .imagem-principal:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease;
        }

        .close-btn:hover {
            background-color: rgba(200, 0, 0, 0.9);
        }

        /* Animações */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modern-button {
            display: flex;
            /* Flex para alinhar o texto e o ícone */
            align-items: center;
            /* Centraliza o conteúdo do botão */
            background: linear-gradient(135deg, #39c4e7, #17859e);
            /* Gradiente para o fundo */
            color: #fff;
            /* Cor do texto */
            padding: 12px 20px;
            /* Espaçamento interno */
            border: none;
            /* Remove a borda padrão */
            border-radius: 50px;
            /* Bordas arredondadas */
            font-size: 16px;
            /* Tamanho da fonte */
            cursor: pointer;
            /* Cursor de ponteiro ao passar o mouse */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            /* Sombra do botão */
            transition: all 0.3s ease;
            /* Suaviza as transições */
            font-family: 'Arial', sans-serif;
            /* Fonte */
            outline: none;
            /* Remove o contorno ao focar */
            position: relative;
            /* Necessário para o efeito de hover */
            overflow: hidden;
            /* Para o efeito de hover não ultrapassar o botão */
            margin-top: 5%;
        }

        /* Ícone no Botão */
        .modern-button i {
            margin-right: 8px;
            /* Espaçamento entre o ícone e o texto */
            font-size: 18px;
            /* Tamanho do ícone */
        }

        /* Efeito de Hover */
        .modern-button:hover {
            background: linear-gradient(135deg, #137d97, #17859e);
            /* Gradiente inverso no hover */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
            /* Sombra mais intensa no hover */
            transform: translateY(-2px);
            /* Levanta o botão no hover */
        }

        /* Efeito de Clique */
        .modern-button:active {
            transform: translateY(2px);
            /* Simula um clique ao descer o botão */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            /* Sombra reduzida ao clicar */
        }

        /* Efeito Futurista: Overlay */
        .modern-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -75px;
            width: 50px;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transform: skewX(-30deg);
            transition: all 0.5s ease;
        }

        .modern-button:hover::before {
            left: 150%;
            transition: all 0.5s ease;
            /* Velocidade do efeito futurista */
        }

        .city-feedback {
            margin-top: 20px;
            /* Espaçamento superior */
            font-size: 18px;
            /* Tamanho da fonte */
            font-weight: bold;
            /* Texto em negrito */
            padding: 15px 25px;
            /* Espaçamento interno */
            background: linear-gradient(135deg, #39c4e7, #17859e);
            /* Gradiente de fundo */
            color: #fff;
            /* Cor do texto */
            border-radius: 12px;
            /* Bordas arredondadas */
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            /* Sombra */
            position: relative;
            /* Para efeitos de pseudo-elementos */
            overflow: hidden;
            /* Para efeitos de hover */
            transition: all 0.3s ease;
            /* Transições suaves */
            text-align: center;
            /* Centraliza o texto */
        }

        /* Efeito de Hover */
        .city-feedback:hover {
            background: linear-gradient(135deg, #137d97, #17859e);
            /* Gradiente invertido no hover */
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
            /* Sombra mais intensa no hover */
            transform: translateY(-2px);
            /* Levanta o elemento no hover */
        }

        /* Efeito Futurista: Overlay */
        .city-feedback::before {
            content: '';
            position: absolute;
            top: -50px;
            left: -50px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.15);
            transform: scale(0);
            border-radius: 50%;
            transition: all 0.5s ease;
        }

        .city-feedback:hover::before {
            transform: scale(3);
            /* Aumenta o círculo no hover */
            left: 50%;
            top: 50%;
            transition: all 0.5s ease;
            /* Velocidade do efeito futurista */
        }

        /* Efeito de Fade-in */
        .city-feedback.fade-in {
            animation: fadeIn 1s ease forwards;
            /* Animação de fade-in */
        }

        /* Keyframes para Fade-in */
        @keyframes fadeIn {
            from {
                opacity: 0;
                /* Começa invisível */
                transform: translateY(20px);
                /* Levemente abaixo */
            }

            to {
                opacity: 1;
                /* Torna-se visível */
                transform: translateY(0);
                /* Sobe para a posição original */
            }
        }

        /* Estilo do header */
        .app-header {
            width: 100%;
            height: 60px;
            /* Altura curta */
            background: linear-gradient(to right, #6dd5ed, #2193b0);
            /* Gradiente futurista */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            /* Sombra leve */
            position: fixed;
            /* Fixa o cabeçalho no topo */
            top: 0;
            left: 0;
            z-index: 1000;
            animation: slideIn 1s ease;
            /* Animação de entrada */
        }

        /* Animação de entrada do header */
        @keyframes slideIn {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Estilo da barra de pesquisa */
        .search-container {
            display: flex;
            align-items: center;
            background-color: white;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            /* Sombra */
            transition: all 0.3s ease;
            /* Animação de hover */
        }

        .search-input {
            border: none;
            padding: 10px 15px;
            width: 150px;
            font-size: 16px;
            outline: none;
            border-radius: 30px 0 0 30px;
            transition: width 0.3s ease;
            /* Animação de foco */
        }

        /* Estilo do botão de pesquisa */
        .search-button {
            background-color: #2193b0;
            border: none;
            padding: 10px;
            color: white;
            cursor: pointer;
            border-radius: 0 30px 30px 0;
            transition: background-color 0.3s ease;
            /* Animação de hover */
        }

        .search-button:hover {
            background-color: #6dd5ed;
        }

        /* Animação de hover na barra de pesquisa */
        .search-container:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .search-input:focus {
            width: 200px;
            /* Expande a barra de pesquisa ao focar */
        }

        /* Ícone da pesquisa */
        .search-button i {
            font-size: 18px;
        }

        #loadMoreButton {
            display: block;
            /* Garante que o botão ocupe toda a linha */
            margin: 20px auto;
            /* Adiciona margem superior e centraliza o botão horizontalmente */
            padding: 10px 20px;
            /* Adiciona espaçamento interno ao botão */
            background-color: #007bff;
            /* Cor de fundo do botão */
            color: #fff;
            /* Cor do texto do botão */
            border: none;
            /* Remove a borda padrão */
            border-radius: 5px;
            /* Arredonda os cantos do botão */
            cursor: pointer;
            /* Muda o cursor para um ponteiro ao passar o mouse */
        }

        #loadMoreButton:hover {
            background-color: #0056b3;
            /* Muda a cor de fundo ao passar o mouse */
        }

        /* CSS */
        .negotiation-icon {
            margin-left: 5%;
            margin-right: 5%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #FF5722;
            /* Ajuste a cor conforme necessário */
        }

        /* Estilo para o container de preview flutuante */
        #previewContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 250px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            z-index: 1000;
            display: none;
            /* O preview só será exibido quando a imagem for carregada */
            transition: transform 0.3s ease-in-out, opacity 0.3s ease;
            cursor: grab;
            /* Indica ao usuário que ele pode arrastar o preview */
        }

        #previewContainer.show {
            display: block;
            transform: translateY(0);
            opacity: 1;
        }

        #previewContainer p {
            margin: 10px 0;
            font-size: 14px;
        }

        #previewContainer img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 4px;
            object-fit: cover;
        }

        /* Animação suave para entrada e saída */
        #previewContainer.hidden {
            opacity: 0;
            transform: translateY(20px);
        }

        /* Melhoria para o conteúdo do preview */
        #mensagemPreview {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        #descricaoPreview {
            font-style: italic;
            color: #333;
        }

        #precoPreview {
            font-weight: bold;
            color: #28a745;
        }

        /* Responsividade - Ocultar o preview em telas menores */
        @media (max-width: 600px) {
            #previewContainer {
                display: none;
            }
        }

        /* Estilo para a área de instrução */
        #instrucoes {
            font-size: 12px;
            color: #555;
            margin-top: 10px;
            font-style: italic;
        }

        #previewContainer:active {
            cursor: grabbing;
            /* Muda o cursor enquanto o usuário arrasta */
        }

        .status-button {
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 18px;
            transition: background-color 0.3s ease, transform 0.3s ease;
            margin: 10px 0;
        }

        .available {
            background-color: #28a745;
            color: white;
        }

        .available:hover {
            background-color: #218838;
        }

        .unavailable {
            background-color: #dc3545;
            color: white;
        }

        .unavailable:hover {
            background-color: #c82333;
        }

        /* Estilo para o botão slim e confortável */
        .capture-button {
            padding: 10px 25px;
            background: linear-gradient(135deg, #00aaff, #0055aa);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Roboto', sans-serif;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 170, 255, 0.3), 0 4px 16px rgba(0, 85, 170, 0.2);
        }

        /* Animação de hover para o botão */
        .capture-button:hover {
            background: linear-gradient(135deg, #0055aa, #00aaff);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 170, 255, 0.4), 0 4px 20px rgba(0, 85, 170, 0.25);
        }

        /* Estilo para a exibição da cidade - Slim e sutil */
        #cidadeUsuario {
            margin-top: 15px;
            font-size: 18px;
            color: #00aaff;
            font-family: 'Roboto', sans-serif;
            letter-spacing: 1px;
            text-shadow: 0 2px 6px rgba(0, 170, 255, 0.4);
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
            transform: translateY(15px);
        }

        /* Animação de fade-in para a cidade */
        #cidadeUsuario.show {
            opacity: 1;
            transform: translateY(0);
        }

        .sector {
            font-family: 'Arial', sans-serif;
            /* Altere para a fonte desejada */
            font-size: 1.2em;
            /* Tamanho da fonte */
            color: #007BFF;
            /* Cor do texto do setor */
            margin: 10px 0;
        }

        .entry-date {
            font-family: 'Arial', sans-serif;
            font-size: 1em;
            color: #6c757d;
            /* Cor cinza */
        }

        .verification-message {
            font-family: 'Arial', sans-serif;
            font-size: 1em;
            color: #28a745;
            /* Cor verde */
            font-weight: bold;
            /* Texto em negrito */
        }

        /* Botão do Histórico */
        .history-button {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            color: #2193b0;
            border-radius: 30px;
            padding: 10px 20px;
            margin-left: 15px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border: none;
            transition: all 0.3s ease;
        }

        /* Ícone no botão */
        .history-button i {
            font-size: 20px;
            margin-right: 8px;
            color: #2193b0;
            transition: transform 0.3s ease;
        }

        /* Animação e Hover */
        .history-button:hover {
            background: linear-gradient(to right, #6dd5ed, #2193b0);
            color: white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .history-button:hover i {
            transform: scale(1.2);
            color: white;
        }

        #storyContainer {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow-x: auto;
            padding: 10px;
        }
    </style>
</head>

<body>

    <header class="app-header">
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Buscar Serviço..." oninput="filterPostsBySearch()" />
            <button class="search-button" onclick="filterPostsBySearch()">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <button class="history-button" onclick="showTab('historicoPedidos')">
            <i class="fas fa-box"></i> Pedidos
            <span id="ordersCounter"
                style="display: none; background: red; color: white; border-radius: 50%; padding: 3px 8px; font-size: 12px; margin-left: 5px;"></span>
        </button>
    </header>

    <div class="container">

        <div class="tabs">
            <div class="tab" onclick="showTab('timeline')"><i class="fas fa-stream"></i><span>Publicações</span>
            </div>
            <div class="tab" onclick="showTab('notificacoes')" id="notificationsTab">
                <i class="fas fa-comment"></i><span>Mensagens</span>
                <span id="notificationCounter" class="notification-counter"></span>
            </div>
            <div class="tab" onclick="showTab('meuPerfil')"><i class="fas fa-user"></i><span>Meu Perfil</span></div>
            <div class="tab" onclick="showTab('Produtor')" id="ProdutorTab" style="display: none;">
                <i class="fas fa-bullhorn"></i><span>Anunciar</span>
            </div>
            <div class="tab" onclick="showTab('financeiro')" id="financeTab" style="display: none;">
                <i class="fas fa-dollar-sign"></i><span>Financeiro</span>
            </div>
            <div class="tab" onclick="showTab('userInfo')"><i class="fas fa-cog"></i><span>Configurações</span></div>
        </div>

        <div id="userInfo" class="tab-content" style="text-align: center;">
            <h2>Informações do Usuário</h2>
            <p id="userFullName"></p>
            <p id="userEmail"></p>
            <h2>Sair</h2>
            <button class="sign-out-btn" onclick="signOut()">Sair</button>
        </div>

        <div id="timeline" class="tab-content active">
            <button onclick="capturarLocalizacao()" class="modern-button">
                <i class="fas fa-map-marker-alt"></i> Localizar minha cidade
            </button>
            <div id="cityFeedback" class="city-feedback"></div>
            <div id="storyContainer" style="display: none; overflow-x: scroll;"></div>
            <div id="storyModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); z-index: 9000;">
                <div id="storyModalContent"
                    style="margin: auto; position: relative; top: 50%; transform: translateY(-50%); max-width: 90%;">
                </div>
            </div>
            <ul class="timeline" id="userTimeline">
                <!-- Timeline items will be dynamically added here -->
            </ul>
        </div>

        <!-- Modal para ver mais detalhes do anuncio -->
        <div id="modalDetalhes" class="modal">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <div id="detalhesAnuncio">
                    <!-- Informações detalhadas serão inseridas dinamicamente aqui -->
                </div>
            </div>
        </div>

        <!-- Imagem em tela cheia -->
        <div id="imagemFullscreen" class="imagem-fullscreen">
            <img id="imagemFullscreenSrc" src="" alt="Imagem em Tela Cheia">
            <span id="closeFullscreen" class="close-fullscreen"><i class="fas fa-times"></i></span>
        </div>

        <div id="notificacoes" class="tab-content" style="text-align: center;">
            <h2>Mensagens</h2>
            <div id="chatList" style="margin-bottom: 20px;">
                <!-- Lista de chats será exibida aqui -->
            </div>
            <div id="chatModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 1000;">
                <div id="chatContainer"
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 800px; background-color: #1a1a2e; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); overflow: hidden; display: flex; flex-direction: column; height: 80%;">
                    <div id="chatHeader"
                        style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: #162447; color: #fff;">
                        <h2 id="chatTitle">Chat</h2>
                        <button onclick="closeChat()"
                            style="background: none; border: none; color: #fff; font-size: 20px; cursor: pointer;">&#10006;</button>
                    </div>
                    <div id="chatMessages" style="flex: 1; padding: 20px; overflow-y: auto; background-color: #1f4068;">
                        <!-- Mensagens do chat aparecerão aqui -->
                    </div>
                    <div id="chatInputContainer"
                        style="display: flex; align-items: center; padding: 15px; background-color: #162447;">
                        <input type="text" id="chatInput" placeholder="Digite sua mensagem..."
                            style="flex: 1; padding: 10px; border: none; border-radius: 20px; margin-right: 10px; outline: none;">
                        <button onclick="sendMessage()"
                            style="background-color: #e43f5a; color: #fff; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer;">Enviar</button>
                    </div>
                </div>
            </div>

        </div>

        <div id="historicoPedidos" class="tab-content" style="text-align: center;">
            <h2>Histórico de Pedidos</h2>
            <div id="ordersContainer" style="margin: 20px;"></div>
        </div>

        <div id="meuPerfil" class="tab-content" style="text-align: center;">
            <h2>Meu Perfil</h2>
            <div>
                <img id="userProfilePicture" src="" alt="Foto de Perfil" loading="lazy">
                <p id="FullName"></p>
                <input type="file" accept="image/*" id="inputFotoPerfil" onchange="handleProfilePictureUpload(event)"
                    style="display: none;">
                <button type="button" id="btnEscolherFotoPerfil" class="upload-button">Escolher Foto de Perfil</button>
            </div>
        </div>

        <div id="userProfileContainer" class="user-profile-container">
            <div class="user-profile-content">
                <button class="close-button" onclick="closeUserProfile()">X</button>
                <img id="userProfilePicturePopUp" alt="Foto do usuário" loading="lazy">
                <p id="userProfileName"></p>
                <p id="userSector" class="sector"></p> <!-- Setor do usuário -->
                <p id="userVerification" class="verification-message"></p> <!-- Mensagem de verificação -->
                <p id="userEntryDate" class="entry-date"></p> <!-- Data de entrada -->
                <div id="userAdsGrid" class="user-ads-grid"></div>
                <ul id="userAdsList"></ul>
            </div>
        </div>

        <!-- Preview do Anúncio -->
        <div id="previewContainer">
            <p>Pré-visualização do anúncio:</p>
            <p id="mensagemPreview"></p>
            <p id="descricaoPreview"></p>
            <p id="precoPreview"></p>
            <div style="display: flex; justify-content: center;">
                <img id="imgPreview" src="#" alt="Preview da Imagem">
            </div>
            <p id="instrucoes">Arraste para mover o preview</p>
        </div>

        <div id="Produtor" class="tab-content">
            <div id="loadingBar" style="display: none; text-align: center; margin-top: 20px;">
                <div
                    style="display: inline-block; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;">
                </div>
            </div>

            <h2>Novo Anúncio</h2>
            <form id="formPublicacao" style="display:none;">
                <div class="form-group">
                    <button type="button" id="btnEscolherArquivo" class="upload-button">Upload Imagem Principal</button>
                    <input type="file" accept="image/*" id="inputImagem" required>
                </div>

                <div class="form-group">
                    <button type="button" id="btnEscolherImagensAdicionais" class="upload-button">Upload Imagens
                        Adicionais</button>
                    <input type="file" accept="image/*" id="inputImagensAdicionais" multiple>
                </div>

                <div class="form-group">
                    <label for="inputMensagem">Título</label>
                    <input type="text" id="inputMensagem" maxlength="200" placeholder="Titulo do anuncio" required>
                </div>

                <div class="form-group">
                    <label for="inputDescricao">Breve Descrição</label>
                    <input type="text" id="inputDescricao" maxlength="200" placeholder="Breve Descrição" required>
                </div>

                <div class="form-group">
                    <label for="inputPreco">Valor do anuncio</label>
                    <input type="number" id="inputPreco" placeholder="Valor em reais R$" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="inputLocalizacao">Localização</label>
                    <input type="text" id="inputLocalizacao" placeholder="Digite sua cidade">
                </div>

                <div class="form-group">
                    <label for="inputTipoServico">Tipo de Serviço</label>
                    <select id="inputTipoServico" required>
                        <option value="" disabled selected>Selecione o tipo de serviço</option>
                        <option value="manicure">Manicure</option>
                        <option value="pedicure">Pedicure</option>
                        <option value="manicurePedicure">Manicure & Pedicure</option>
                        <option value="designerSobrancelhas">Designer de Sobrancelhas</option>
                        <option value="maquiagem">Maquiagem</option>
                        <option value="massagem">Massagem</option>
                        <option value="depilacao">Depilação</option>
                        <option value="alongamentoCilios">Alongamento de Cílios</option>
                        <option value="tratamentoCapilar">Tratamento Capilar</option>
                        <option value="outros">Outros Serviços</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="inputDuracao">Duração do Serviço (horas)</label>
                    <input type="number" id="inputDuracao" placeholder="Duração em horas" step="0.1" required>
                </div>

                <button type="submit">Publicar</button>
            </form>

            <div id="avisoNaoProdutor" style="display: none; margin-top: 15%;">
                <p>Você não é um anunciante parceiro.</p>
                <p>
                    <a href="https://api.whatsapp.com/send?phone=551996564968&text=Gostaria%20de%20anunciar%20meu%20veiculo%20na%20plataforma%20motorZapp"
                        target="_blank">
                        Cadastre-se agora como um anunciante em nossa plataforma
                    </a>
                </p>
            </div>

        </div>

        <div id="financeiro" class="tab-content">
            <div id="financialContainer"></div>
        </div>

        <footer>
            <p>&copy; 2024 LC Company. Todos os direitos reservados.</p>
            <nav>
                <a href="dashboard.html">Início</a>
                <a href="#about">Sobre</a>
                <a href="PoliticaPrivacidade.html">Politica de Privacidade</a>
                <a href="TermosDeUso.html">Termos de Uso</a>
            </nav>
        </footer>

    </div>

    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFXwGNyaOhJJQz5YeGTZU9vCHKuq1idcA&loading=async&libraries=places"></script>

    <!--bibliotecas do Firebase -->
    <script type="module">
        // Importar as bibliotecas do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, getDocs, deleteDoc, serverTimestamp, query, orderBy, where, arrayUnion, onSnapshot, startAfter, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";
        import { updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { deleteObject } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        // Configurações do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyATKjtf2xqjdVtZFHSdrZOcA0Taa3J4gao",
            authDomain: "redesocialmarktplace.firebaseapp.com",
            projectId: "redesocialmarktplace",
            storageBucket: "redesocialmarktplace.appspot.com",
            messagingSenderId: "389449887892",
            appId: "1:389449887892:web:e87a07a73c04b2ad9d8481",
            measurementId: "G-KQ8Q4LZVB1"
        };

        // Inicializar o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const user = auth.currentUser;

        // Verificar se o usuário está autenticado
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userId = user.uid;

                // Executar todas as funções necessárias
                getUserInfo(userId);
                getUserTimeline(userId);
                getAllUserTimeline();
                exibirPerfilUsuario(userId);
                checkUserRole();
                monitorChats(userId);
                restoreNotificationCounter();
                updateOrdersCounter();
                displayFinancialHistory(userId);
                createStoryForm(userId);
                initAutocomplete();

                // Atualizar a última atividade do usuário
                const userDocRef = doc(db, "users", userId);
                await updateDoc(userDocRef, {
                    lastActive: serverTimestamp(),
                });

                // Recuperar a lista de pedidos
                const orders = await fetchOrdersForUser(userId); // Busca os pedidos do usuário

                // Configurar o evento de clique no botão para gerar o relatório
                const downloadButton = document.getElementById("downloadPDF");
                if (downloadButton) {
                    downloadButton.addEventListener("click", () => {
                        generateFinancialReportPDF(orders, userId);
                    });
                } else {
                    console.error("Botão 'downloadPDF' não encontrado no DOM.");
                }
            } else {
                window.location.href = "login.html";
                console.log("Usuário não autenticado.");
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // Captura todos os elementos de entrada relevantes na página
            const inputs = document.querySelectorAll('input, textarea, select, [contenteditable="true"]');

            inputs.forEach(input => {
                input.addEventListener('input', (event) => {
                    // Verificar o tipo de entrada
                    if (event.target.tagName === 'INPUT' && event.target.type !== 'file') {
                        // Aplicar sanitização no valor
                        event.target.value = DOMPurify.sanitize(event.target.value, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
                    } else if (event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                        // Aplicar sanitização no valor
                        event.target.value = DOMPurify.sanitize(event.target.value, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
                    } else if (event.target.getAttribute('contenteditable') === 'true') {
                        // Para elementos contenteditable, sanitizar o innerHTML
                        event.target.innerHTML = DOMPurify.sanitize(event.target.innerHTML, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
                    }
                });
            });
        });

        // Variável global para armazenar a cidade atual
        let cidadeAtual = '';

        // Função para capturar a localização e armazenar a cidade atual para filtrar os pots e os stories
        window.capturarLocalizacao = function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async function (position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;

                    // Chama a função para converter as coordenadas em nome da cidade
                    cidadeAtual = await converterCoordenadasParaCidade(latitude, longitude);

                    if (cidadeAtual) {
                        console.log(`Localização capturada: Latitude ${latitude}, Longitude ${longitude}, Cidade: ${cidadeAtual}`);

                        // Exibir os stories e o botão de adicionar stories
                        document.getElementById("storyContainer").style.display = "flex";

                        // Chamar a função displayStories com a cidade capturada
                        displayStories(cidadeAtual);

                        // Mostra o feedback da cidade na tela
                        document.getElementById("cityFeedback").textContent = `Exibindo resultados para: ${cidadeAtual}`;

                        // Chama a função filterPosts() para filtrar com base na cidade capturada
                        filterPosts(cidadeAtual);

                    } else {
                        console.error('Não foi possível determinar a cidade.');
                        document.getElementById("cityFeedback").textContent = 'Não foi possível determinar sua cidade.';
                    }
                }, function (error) {
                    console.error('Erro ao capturar localização:', error);
                    document.getElementById("cityFeedback").textContent = 'Erro ao capturar localização.';
                });
            } else {
                console.error('Geolocalização não suportada pelo navegador.');
                document.getElementById("cityFeedback").textContent = 'Geolocalização não suportada pelo navegador.';
            }
        };

        // Função para converter coordenadas em cidade
        async function converterCoordenadasParaCidade(latitude, longitude) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
                const data = await response.json();
                if (data && data.address && data.address.city) {
                    return data.address.city;
                } else {
                    console.error('Não foi possível obter o nome da cidade a partir das coordenadas.');
                    return null;
                }
            } catch (error) {
                console.error('Erro ao converter coordenadas para cidade:', error);
                return null;
            }
        }

        // Função para obter informações do usuário
        async function getUserInfo(uid) {
            const userDoc = await getDocs(collection(db, "users"));
            userDoc.forEach((doc) => {
                if (doc.id === uid) {
                    const userData = doc.data();
                    document.getElementById("userFullName").textContent = `Nome: ${userData.fullName}`;
                    document.getElementById("userEmail").textContent = `Email: ${userData.email}`;
                }
            });
        }

        let cidadeSelecionada = null;

        // Função que inicializa o Autocomplete para o campo de story
        function initAutocompleteStory() {
            try {
                if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.places === 'undefined') {
                    throw new Error("API do Google Maps não carregada corretamente.");
                }

                const inputLocalizacaoStory = document.getElementById("inputLocalizacaoStory"); // Usando o novo ID

                // Inicializa o autocomplete para o campo específico do modal
                const autocomplete = new google.maps.places.Autocomplete(inputLocalizacaoStory, {
                    types: ['geocode'],
                    componentRestrictions: { country: "br" }
                });

                autocomplete.addListener('place_changed', function () {
                    currentPlace = autocomplete.getPlace(); // Atualiza a variável global com o local selecionado
                    if (!currentPlace.geometry) {
                        alert("Por favor, selecione um endereço válido da lista de sugestões.");
                        return;
                    }

                    // Captura a cidade do endereço
                    cidadeSelecionada = currentPlace.address_components.find(component =>
                        component.types.includes("administrative_area_level_2")
                    )?.long_name || "Cidade não identificada";

                    console.log("Cidade selecionada:", cidadeSelecionada);
                    console.log("Endereço:", currentPlace.formatted_address);
                    console.log("Latitude:", currentPlace.geometry.location.lat());
                    console.log("Longitude:", currentPlace.geometry.location.lng());
                });
            } catch (error) {
                console.error("Erro ao inicializar Autocomplete:", error);
                alert("Ocorreu um erro ao carregar o Google Maps. A página será recarregada.");
                window.location.reload(); // Recarrega a página se a API do Google Maps não for carregada
            }
        }

        async function openStoryModal(userUid) {
            // Criar ou mostrar o modal de upload
            const modal = document.createElement("div");
            modal.id = "uploadStoryModal";
            modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    `;

            const modalContent = document.createElement("div");
            modalContent.style.cssText = `
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        width: 90%;
        max-width: 400px;
        text-align: center;
    `;

            // Input para upload do arquivo
            const fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.accept = "image/*,video/*";
            fileInput.style.marginBottom = "10px";

            const uploadButton = document.createElement("button");
            uploadButton.textContent = "Publicar Story";
            uploadButton.style.cssText = `
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
    `;

            const closeButton = document.createElement("button");
            closeButton.textContent = "Cancelar";
            closeButton.style.cssText = `
        background-color: #ccc;
        color: black;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
    `;

            closeButton.onclick = () => {
                modal.remove();
            };

            // Adicionar o campo de localização
            const locationInput = document.createElement("input");
            locationInput.id = "inputLocalizacaoStory";  // Novo ID único para o input de localização no modal
            locationInput.type = "text";
            locationInput.placeholder = "Digite sua localização...";
            locationInput.style.marginBottom = "10px";
            modalContent.appendChild(locationInput);

            modalContent.appendChild(fileInput);
            modalContent.appendChild(document.createElement("br"));
            modalContent.appendChild(uploadButton);
            modalContent.appendChild(closeButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Chama a função de publicação do story
            uploadButton.onclick = async () => {
                if (fileInput.files.length === 0) {
                    alert("Por favor, selecione um arquivo para publicar.");
                    return;
                }

                if (!cidadeSelecionada) {
                    alert("Por favor, selecione uma cidade antes de continuar.");
                    return;
                }

                displayStories(cidadeSelecionada);

                const file = fileInput.files[0];
                await saveStory(userUid, file);
                modal.remove();
            };

            // Inicializa o Autocomplete do Google Maps para o campo do modal
            initAutocompleteStory(); // Função específica para o campo de localização do modal
        }

        async function createStoryForm(userUid, photoURL) {
            if (!photoURL) {
                try {
                    const userDoc = await getDoc(doc(db, "users", userUid));
                    if (userDoc.exists()) {
                        photoURL = userDoc.data().photoURL || "default-profile.png";
                    } else {
                        console.error("Usuário não encontrado.");
                        photoURL = "default-profile.png"; // Imagem padrão
                    }
                } catch (error) {
                    console.error("Erro ao buscar photoURL:", error);
                    photoURL = "default-profile.png"; // Imagem padrão
                }
            }

            const storyContainer = document.getElementById("storyContainer");

            // Botão para criar story
            const addStory = document.createElement("div");
            addStory.id = "addStoryButton";
            addStory.style.cssText = `
        position: relative;
        display: none;
        margin: 10px;
        cursor: pointer;
    `;

            const userPhoto = document.createElement("img");
            userPhoto.src = photoURL;
            userPhoto.alt = "Foto do Usuário";
            userPhoto.style.cssText = `
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 2px solid #007bff;
    `;
            addStory.appendChild(userPhoto);

            const plusIcon = document.createElement("span");
            plusIcon.textContent = "+";
            plusIcon.style.cssText = `
        position: absolute;
        bottom: 5px;
        right: 5px;
        background-color: #007bff;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
    `;
            addStory.appendChild(plusIcon);

            addStory.onclick = () => openStoryModal(userUid);
            storyContainer.appendChild(addStory);

            checkUserRole();
        }

        async function saveStory(userUid, file) {
            try {
                if (!cidadeSelecionada) {
                    alert("Por favor, selecione uma localização válida antes de publicar.");
                    return;
                }

                const storyRef = collection(db, "stories");
                const timestamp = Date.now();
                const filePath = `stories/${userUid}/${timestamp}-${file.name}`;
                const fileRef = ref(storage, filePath);

                // Fazer upload do arquivo
                await uploadBytes(fileRef, file);
                const fileURL = await getDownloadURL(fileRef);

                // Detectar o tipo de arquivo (imagem ou vídeo)
                const isVideo = file.type.startsWith("video");

                // Salvar no Firestore, incluindo a cidade
                await addDoc(storyRef, {
                    userUid,
                    timestamp,
                    fileURL,
                    cidade: cidadeSelecionada, // Salva a cidade capturada
                    expiresAt: timestamp + 24 * 60 * 60 * 1000, // Expira em 24 horas
                    isVideo, // Adiciona essa informação ao Firestore
                });

                alert("Story publicado com sucesso!");
            } catch (error) {
                console.error("Erro ao salvar o story:", error);
                alert("Não foi possível publicar o story.");
            }
        }

        async function displayStories(cidade) {
            try {
                // Verifique se a cidade foi passada corretamente
                if (!cidade) {
                    throw new Error("A cidade não foi especificada.");
                }

                const storyRef = collection(db, "stories");
                const now = Date.now();

                // Consulta para obter os stories válidos para a cidade
                const storiesSnapshot = await getDocs(
                    query(
                        storyRef,
                        where("expiresAt", ">", now),
                        where("cidade", "==", cidade),
                        orderBy("timestamp", "desc")
                    )
                );

                const storyContainer = document.getElementById("storyContainer");
                storyContainer.innerHTML = ""; // Limpar container

                // Adicionar botão de criar Story
                const currentUserUid = auth.currentUser.uid;
                const currentUserPhotoURL = auth.currentUser.photoURL;
                await createStoryForm(currentUserUid, currentUserPhotoURL);

                // Renderizar stories
                storiesSnapshot.forEach((doc) => {
                    const story = doc.data();

                    const storyItem = document.createElement("div");
                    storyItem.style.cssText = `
                position: relative;
                display: inline-block;
                margin: 10px;
                cursor: pointer;
            `;

                    if (story.isVideo) {
                        // Miniatura do vídeo
                        const videoThumbnail = document.createElement("video");
                        videoThumbnail.src = story.fileURL;
                        videoThumbnail.alt = "Story Video";
                        videoThumbnail.style.cssText = `
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    border: 2px solid #ffc107;
                `;
                        videoThumbnail.muted = true;
                        videoThumbnail.autoplay = false;
                        videoThumbnail.controls = false;
                        videoThumbnail.loop = false;

                        storyItem.appendChild(videoThumbnail);
                    } else {
                        // Imagem
                        const storyImage = document.createElement("img");
                        storyImage.src = story.fileURL;
                        storyImage.alt = "Story";
                        storyImage.style.cssText = `
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    border: 2px solid #ffc107;
                `;
                        storyItem.appendChild(storyImage);
                    }

                    storyItem.onclick = () => viewStory(story.fileURL, story.isVideo);
                    storyContainer.appendChild(storyItem);
                });
            } catch (error) {
                console.error("Erro ao exibir stories:", error);
                alert("Não foi possível carregar os stories. Verifique se a cidade está correta.");
            }
        }

        function viewStory(fileURL, isVideo) {
            const modal = document.getElementById("storyModal");
            const modalContent = document.getElementById("storyModalContent");

            if (isVideo) {
                modalContent.innerHTML = `
            <video controls autoplay style="width: 100%; height: auto;">
                <source src="${fileURL}" type="video/mp4">
                Seu navegador não suporta vídeos.
            </video>
        `;
            } else {
                modalContent.innerHTML = `<img src="${fileURL}" style="width: 100%; height: auto;">`;
            }

            modal.style.display = "block";

            modal.onclick = () => {
                modal.style.display = "none";
            };
        }

        // Função para obter a timeline do usuário
        async function getUserTimeline(uid) {
            const publicacoesRef = collection(db, "publicacoes");
            const querySnapshot = await getDocs(publicacoesRef);
            if (!querySnapshot.empty) {
                const userTimeline = document.getElementById("userTimeline");
                userTimeline.innerHTML = ""; // Limpar a timeline antes de adicionar novos itens
                querySnapshot.forEach((doc) => {
                    const publicacaoData = doc.data();
                    if (publicacaoData.userId === uid) {
                        const li = document.createElement("li");
                        li.classList.add("timeline-item");
                        li.innerHTML = `
                        <p>${publicacaoData.mensagem}</p>
                        <img src="${publicacaoData.imagemUrl}" class="publicacao-img" alt="Publicação" loading="lazy">
                        <p>Data e Hora: ${publicacaoData.timestamp}</p>`;
                        userTimeline.appendChild(li);
                    }
                });
            } else {
                console.log("Nenhuma publicação encontrada.");
            }
        }

        let currentPlace = null; // Variável global para armazenar o lugar selecionado

        // Inicializando o Autocomplete da API do Google Maps no campo de localização
        function initAutocomplete() {
            try {
                if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.places === 'undefined') {
                    throw new Error("API do Google Maps não carregada corretamente.");
                }

                const inputLocalizacao = document.getElementById("inputLocalizacao");

                const autocomplete = new google.maps.places.Autocomplete(inputLocalizacao, {
                    types: ['geocode'],
                    componentRestrictions: { country: "br" }
                });

                autocomplete.addListener('place_changed', function () {
                    currentPlace = autocomplete.getPlace(); // Atualiza a variável global
                    if (!currentPlace.geometry) {
                        alert("Por favor, selecione um endereço válido da lista de sugestões.");
                        return;
                    }

                    console.log("Endereço:", currentPlace.formatted_address);
                    console.log("Latitude:", currentPlace.geometry.location.lat());
                    console.log("Longitude:", currentPlace.geometry.location.lng());
                });
            } catch (error) {
                console.error("Erro ao inicializar Autocomplete:", error);
                alert("Ocorreu um erro ao carregar o Google Maps. A página será recarregada.");
                window.location.reload(); // Recarrega a página se a API do Google Maps não for carregada
            }
        }

        // Função para publicar uma nova publicação
        document.getElementById("formPublicacao").addEventListener("submit", async (e) => {
            e.preventDefault();

            document.getElementById("loadingBar").style.display = "block";

            const mensagem = document.getElementById("inputMensagem").value;
            const descricao = document.getElementById("inputDescricao").value;
            const precoInput = document.getElementById("inputPreco").value;
            const imagemPrincipal = document.getElementById("inputImagem").files[0];
            const imagensAdicionais = document.getElementById("inputImagensAdicionais").files;
            const tipoServico = document.getElementById("inputTipoServico").value;
            const localizacao = document.getElementById("inputLocalizacao").value;
            const duracao = document.getElementById("inputDuracao").value;

            if (!imagemPrincipal) {
                alert("Por favor, selecione uma imagem principal.");
                document.getElementById("loadingBar").style.display = "none";
                return;
            }

            const preco = parseFloat(precoInput.replace(/[^\d,]/g, '').replace(',', '.'));

            if (isNaN(preco)) {
                alert("Por favor, insira um preço válido.");
                document.getElementById("loadingBar").style.display = "none";
                return;
            }

            try {
                // Upload da imagem principal
                const compressedBlobPrincipal = await compressImage(imagemPrincipal);
                const storageRefPrincipal = ref(storage, `imagens/${imagemPrincipal.name}`);
                const snapshotPrincipal = await uploadBytes(storageRefPrincipal, compressedBlobPrincipal);
                const imagemPrincipalUrl = await getDownloadURL(snapshotPrincipal.ref);

                // Upload das imagens adicionais
                const imagensAdicionaisUrls = [];
                for (let i = 0; i < imagensAdicionais.length; i++) {
                    const imagemAdicional = imagensAdicionais[i];
                    const compressedBlobAdicional = await compressImage(imagemAdicional);
                    const storageRefAdicional = ref(storage, `imagens/adicionais/${imagemAdicional.name}`);
                    const snapshotAdicional = await uploadBytes(storageRefAdicional, compressedBlobAdicional);
                    const imagemAdicionalUrl = await getDownloadURL(snapshotAdicional.ref);
                    imagensAdicionaisUrls.push(imagemAdicionalUrl);
                }

                // Enviando os dados para o Firestore
                await addDoc(collection(db, "publicacoes"), {
                    mensagem: mensagem,
                    descricao: descricao,
                    preco: preco,
                    imagemUrl: imagemPrincipalUrl,
                    imagensAdicionaisUrls: imagensAdicionaisUrls,
                    localizacao: localizacao,
                    tipoServico: tipoServico,
                    duracao: duracao,
                    timestamp: serverTimestamp(),
                    userId: auth.currentUser.uid,
                });

                // Limpar os campos do formulário
                document.getElementById("inputMensagem").value = "";
                document.getElementById("inputDescricao").value = "";
                document.getElementById("inputPreco").value = "";
                document.getElementById("inputImagem").value = "";
                document.getElementById("inputImagensAdicionais").value = "";
                document.getElementById("inputLocalizacao").value = "";
                document.getElementById("inputTipoServico").value = "";
                document.getElementById("inputDuracao").value = "";

                location.reload();

            } catch (error) {
                console.error("Erro ao publicar anúncio: ", error);
                alert("Ocorreu um erro ao publicar o anúncio. Tente novamente.");
            } finally {
                document.getElementById("loadingBar").style.display = "none";
            }
        });

        document.getElementById("btnEscolherImagensAdicionais").addEventListener("click", () => {
            document.getElementById("inputImagensAdicionais").click();
        });

        // Função para verificar o papel do usuário
        async function checkUserRole() {
            const user = auth.currentUser;
            if (!user) {
                return;
            }

            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                if (userData.role === "Anunciante") {
                    document.getElementById("formPublicacao").style.display = "block";
                    document.getElementById("financeTab").style.display = "block";
                    document.getElementById("ProdutorTab").style.display = "block";

                    // Torna o botão de criar stories visível
                    const addStoryButton = document.getElementById("addStoryButton");
                    if (addStoryButton) {
                        addStoryButton.style.display = "inline-block"; // Torna o botão visível
                    }
                } else {
                    document.getElementById("avisoNaoProdutor").style.display = "block";
                }
            } else {
                console.log("Documento do usuário não encontrado.");
            }
        }

        // Chame a função para verificar o papel do usuário ao carregar a página
        window.onload = checkUserRole;

        // Função para comprimir a imagem
        window.compressImage = async function (imageFile) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = function (event) {
                    const img = new Image();

                    img.onload = function () {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Definir as dimensões máximas da imagem
                        const maxWidth = 1280;
                        const maxHeight = 720;

                        let width = img.width;
                        let height = img.height;

                        // Redimensionar a imagem mantendo a proporção
                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        // Desenhar a imagem redimensionada no canvas
                        ctx.drawImage(img, 0, 0, width, height);

                        // Converter o canvas de volta para Blob
                        canvas.toBlob((blob) => {
                            resolve(blob);
                        }, 'image/png', 0.9); // Comprimir para PNG com 90% de qualidade
                    };

                    img.src = event.target.result;
                };

                reader.readAsDataURL(imageFile);
            });
        }

        // Função para alternar entre as abas
        window.showTab = function (tabId) {
            const tabs = document.querySelectorAll(".tab-content");
            tabs.forEach(tab => {
                tab.classList.remove("active");
            });
            const selectedTab = document.getElementById(tabId);
            selectedTab.classList.add("active");

            // Atualiza o perfil quando a aba "Meu Perfil" é selecionada
            if (tabId === 'meuPerfil') {
                // Chama a função para exibir o perfil do usuário logado
                exibirPerfilUsuario(auth.currentUser.uid); // Passando o UID do usuário logado
            }

            if (tabId === 'notificacoes') {
                loadChats(auth.currentUser.uid);
                resetNotificationCounter(); // Zerando o contador ao abrir a aba de notificações
            }

            // Exibe os pedidos na aba de Histórico de Pedidos
            if (tabId === 'historicoPedidos') {
                displayOrders(); // Função para buscar e renderizar pedidos
            }
        }

        // Função para filtrar posts com base na cidade
        window.filterPosts = function (cidade) {
            cidadeAtual = cidade.toLowerCase(); // Atualiza a cidade atual
            const timelineItems = Array.from(document.querySelectorAll("#userTimeline .timeline-item"));

            const data = timelineItems.map(item => ({
                element: item,
                message: (item.dataset.message || '').toLowerCase(),
                description: (item.dataset.description || '').toLowerCase(),
                location: (item.dataset.location || '').toLowerCase()
            }));

            const fuse = new Fuse(data, {
                keys: ['message', 'description', 'location'],
                threshold: 0.3
            });

            let results;
            if (cidadeAtual.trim() === "") {
                results = data.map(item => ({ item }));
            } else {
                results = fuse.search(cidadeAtual);
            }

            timelineItems.forEach(item => item.style.display = "none");
            results.forEach(result => {
                if (result.item.location.includes(cidadeAtual)) {
                    result.item.element.style.display = "block";
                }
            });
        };

        // Função para filtrar posts com base na pesquisa
        window.filterPostsBySearch = async function () {
            const searchInputElement = document.querySelector('.search-input');
            const searchInput = searchInputElement ? searchInputElement.value.toLowerCase() : '';
            let foundMatch = false; // Variável para controlar se a busca encontrou algum item correspondente
            let page = 1; // Controle de página para carregamento

            // Função para aplicar a pesquisa nos itens carregados
            const applyFilter = (timelineItems) => {
                Array.from(timelineItems).forEach(item => {
                    const message = item.getAttribute('data-message') ? item.getAttribute('data-message').toLowerCase() : '';
                    const description = item.getAttribute('data-description') ? item.getAttribute('data-description').toLowerCase() : '';
                    const location = item.getAttribute('data-location') ? item.getAttribute('data-location').toLowerCase() : '';

                    if ((message.includes(searchInput) || description.includes(searchInput)) && location.includes(cidadeAtual)) {
                        item.style.display = ''; // Mostra o item se corresponder
                        foundMatch = true; // Encontrou ao menos um item
                    } else {
                        item.style.display = 'none'; // Esconde o item se não corresponder
                    }
                });
            };

            // Inicialmente aplica o filtro nos itens já carregados
            const userTimeline = document.getElementById('userTimeline');
            if (userTimeline) {
                const timelineItems = userTimeline.getElementsByClassName('timeline-item');
                applyFilter(timelineItems);
            }

            // Se não encontrar correspondências nos itens atuais, carrega mais
            while (!foundMatch && page <= 10) { // Limite de páginas para evitar loops infinitos
                await window.getAllUserTimeline(false); // Carrega mais publicações (continuação da paginação)

                // Aplica o filtro novamente com os novos itens carregados
                const newItems = userTimeline.getElementsByClassName('timeline-item');
                applyFilter(newItems);

                page++;
            }

            // Se não encontrar nenhum item correspondente após todas as páginas, exibe uma mensagem
            if (!foundMatch) {
                console.log('Nenhum item encontrado na pesquisa.');
            }
        };

        // Variáveis de controle de paginação
        let lastVisible = null; // Para armazenar o último documento visível
        const pageSize = 5; // Número de documentos a serem carregados por página
        let isFetching = false; // Flag para evitar múltiplas chamadas

        // Função para obter anuncios dos usuários
        window.getAllUserTimeline = async function (isInitialLoad = true) {
            if (isFetching) return; // Não permitir múltiplas execuções simultâneas
            isFetching = true;

            const userTimeline = document.getElementById("userTimeline");

            if (isInitialLoad) {

                // Mostrar Skeleton Loader antes de carregar os dados
                for (let i = 0; i < pageSize; i++) {
                    const skeletonLi = document.createElement("li");
                    skeletonLi.classList.add("timeline-item");

                    // Contêiner do skeleton
                    const skeletonContainer = document.createElement("div");
                    skeletonContainer.classList.add("skeleton-container");

                    // Imagem do usuário
                    const skeletonImg = document.createElement("div");
                    skeletonImg.classList.add("skeleton", "skeleton-img");
                    skeletonContainer.appendChild(skeletonImg);

                    // Texto do usuário
                    const skeletonText = document.createElement("div");
                    skeletonText.classList.add("skeleton", "skeleton-text");
                    skeletonContainer.appendChild(skeletonText);

                    // Adiciona o container do skeleton ao item da lista
                    skeletonLi.appendChild(skeletonContainer);

                    // Adiciona um skeleton de texto para a mensagem
                    const skeletonMessage = document.createElement("div");
                    skeletonMessage.classList.add("skeleton", "skeleton-text");
                    skeletonLi.appendChild(skeletonMessage);

                    // Adiciona um skeleton para a imagem da publicação (se houver)
                    const skeletonFull = document.createElement("div");
                    skeletonFull.classList.add("skeleton", "skeleton-full");
                    skeletonLi.appendChild(skeletonFull);

                    // Adiciona o skeleton à linha do tempo
                    userTimeline.appendChild(skeletonLi);
                }
            }

            try {
                const publicacoesRef = collection(db, "publicacoes");
                let q;

                // Configurar a consulta com base na paginação
                if (isInitialLoad) {
                    q = query(publicacoesRef, orderBy("timestamp", "desc"), limit(pageSize));
                } else {
                    q = query(publicacoesRef, orderBy("timestamp", "desc"), startAfter(lastVisible), limit(pageSize));
                }

                const querySnapshot = await getDocs(q);

                if (isInitialLoad) userTimeline.innerHTML = ""; // Limpar a linha do tempo antes de adicionar novos itens

                // Atualizar o último documento visível
                lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];

                querySnapshot.forEach(async (doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    console.log("Publicações exibidas com sucesso");
                    const timestamp = data.timestamp.toDate();
                    const dia = String(timestamp.getDate()).padStart(2, '0');
                    const mes = String(timestamp.getMonth() + 1).padStart(2, '0');
                    const ano = timestamp.getFullYear();
                    const horas = String(timestamp.getHours()).padStart(2, '0');
                    const minutos = String(timestamp.getMinutes()).padStart(2, '0');
                    const dataFormatada = `${dia}/${mes}/${ano} ${horas}:${minutos}`;
                    const message = data.mensagem || '';  // Certifique-se de que esses campos estejam no Firestore
                    const description = data.descricao || '';
                    const location = (data.localizacao || '').toLowerCase();  // Certifique-se de usar toLowerCase()

                    const user = await getUserData(data.userId);

                    // Criação do elemento li para cada publicação
                    const li = document.createElement("li");
                    li.classList.add("timeline-item");
                    li.style.backgroundColor = "#f0f0f0";
                    li.style.padding = "10px";
                    li.style.borderRadius = "4px";
                    li.style.marginBottom = "15%";
                    li.style.marginTop = "10%";
                    li.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)"; // Estilo 3D padrão
                    li.style.transition = "all 0.3s ease"; // Transição suave
                    li.style.transform = "translateY(0)"; // Posição padrão

                    // Criar o link dinâmico
                    const linkAnuncio = document.createElement("a");
                    linkAnuncio.href = `/anuncio/${docId}`;  // URL dinâmica para cada anúncio
                    linkAnuncio.style.textDecoration = "none";
                    linkAnuncio.style.color = "inherit";

                    const link = document.createElement("a");
                    link.href = `/anuncio/${doc.id}`; // Cria o link dinâmico com base no ID do documento (anúncio)
                    link.textContent = "Ver anúncio";
                    link.style.color = "#3498db"; // Cor do link
                    link.style.textDecoration = "none"; // Remover sublinhado
                    link.style.display = "none"; //oculto enquanto não esta funcionando corretamente, após correçaõ remover essa linha
                    li.appendChild(link); // Adiciona o link ao elemento li

                    // Adicionar atributos de dados para filtragem
                    li.setAttribute('data-message', message);
                    li.setAttribute('data-description', description);
                    li.setAttribute('data-location', location);

                    // Função para aplicar o estilo de hover/touch
                    function applyHoverStyles() {
                        li.style.boxShadow = "0 20px 40px rgba(0, 0, 0, 0.5)"; // Sombra mais forte
                        li.style.transform = "translateY(-10px)"; // Levanta o item mais
                    }

                    // Função para remover o estilo de hover/touch
                    function removeHoverStyles() {
                        li.style.boxShadow = "0 10px 20px rgba(0, 0, 0, 0.3)"; // Sombra padrão
                        li.style.transform = "translateY(0)"; // Volta à posição original
                    }

                    // Adiciona os eventos de mouse e toque
                    li.addEventListener("mouseover", applyHoverStyles);
                    li.addEventListener("mouseout", removeHoverStyles);
                    li.addEventListener("touchstart", applyHoverStyles, { passive: true }); // Para dispositivos móveis
                    li.addEventListener("touchend", removeHoverStyles, { passive: true }); // Para dispositivos móveis

                    // Criar um contêiner para a foto do usuário e o nome do usuário
                    const userInfoContainer = document.createElement("div");
                    userInfoContainer.style.display = "flex";
                    userInfoContainer.style.alignItems = "center";
                    userInfoContainer.style.marginBottom = "10px";

                    // Adicionar a foto do usuário ao contêiner
                    const userImg = document.createElement("img");
                    userImg.src = user.photoURL;
                    userImg.alt = "Foto do usuário";
                    userImg.style.width = "60px";
                    userImg.style.height = "60px";
                    userImg.style.borderRadius = "50%";
                    userImg.style.marginRight = "15px";
                    userImg.style.cursor = "pointer";
                    userImg.style.border = "2px solid #ddd"; // Borda sutil
                    userImg.onclick = () => showUserProfile(user.userId); // Abrir o perfil do usuário ao clicar na foto
                    userInfoContainer.appendChild(userImg);

                    // Adicionar o nome do usuário ao contêiner
                    const userName = document.createElement("p");
                    userName.textContent = user.fullName;
                    userName.style.fontWeight = "bold";
                    userName.style.cursor = "pointer";
                    userName.onclick = () => showUserProfile(user.userId); // Abrir o perfil do usuário ao clicar no nome

                    // Adicionar o nome do usuário
                    userName.textContent = user.fullName;

                    // Criar o ícone de verificado
                    const verifiedIcon = document.createElement("i");
                    verifiedIcon.classList.add("fas", "fa-check-circle"); // Adiciona a classe Font Awesome para o ícone de verificado
                    verifiedIcon.style.color = "#007bff"; // Define a cor azul do ícone
                    verifiedIcon.style.marginLeft = "8px"; // Espaço entre o nome e o ícone

                    // Adicionar o nome do usuário e o ícone ao contêiner
                    userName.append(verifiedIcon); // Coloca o ícone depois do nome

                    userInfoContainer.appendChild(userName);

                    // Adicionar o contêiner de informações do usuário ao li
                    li.appendChild(userInfoContainer);

                    // Adicionar a mensagem (Título) da publicação
                    const mensagem = document.createElement("p");
                    mensagem.textContent = data.mensagem;
                    mensagem.style.marginBottom = "10px";
                    mensagem.style.fontSize = "18px";
                    mensagem.style.fontWeight = "bold";
                    mensagem.style.color = "#2c3e50"; // Cor mais moderna
                    mensagem.style.display = "flex";
                    mensagem.style.alignItems = "center";

                    // Adicionar um ícone ao lado do título
                    const mensagemIcon = document.createElement("i");
                    mensagemIcon.classList.add("fas", "fa-clipboard"); // Ícone de um bloco de notas
                    mensagemIcon.style.color = "#3498db"; // Azul
                    mensagemIcon.style.marginRight = "8px";

                    mensagem.prepend(mensagemIcon); // Adicionar o ícone antes do texto
                    li.appendChild(mensagem);

                    // Adicionar a descrição do produto
                    const descricao = document.createElement("p");
                    descricao.textContent = `${data.descricao}`;
                    descricao.style.fontSize = "14px";
                    descricao.style.color = "#666";
                    descricao.style.marginBottom = "10px";
                    descricao.style.display = "flex";
                    descricao.style.alignItems = "center";

                    // Adicionar um ícone ao lado da descrição
                    const descricaoIcon = document.createElement("i");
                    descricaoIcon.classList.add("fas", "fa-info-circle"); // Ícone informativo
                    descricaoIcon.style.color = "#95a5a6";
                    descricaoIcon.style.marginRight = "8px";

                    descricao.prepend(descricaoIcon); // Adicionar o ícone antes do texto
                    li.appendChild(descricao);

                    // Adicionar o preço do produto
                    const preco = data.preco; // O valor recuperado do banco de dados

                    if (!isNaN(preco)) {
                        // Formatar o preço como moeda BRL
                        const precoFormatado = parseFloat(preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                        const precoElemento = document.createElement("p");
                        precoElemento.textContent = `${precoFormatado}`;
                        precoElemento.style.fontSize = "16px";
                        precoElemento.style.fontWeight = "bold";
                        precoElemento.style.color = "#27ae60"; // Verde para destacar o preço
                        precoElemento.style.marginBottom = "10px";
                        precoElemento.style.display = "flex";
                        precoElemento.style.alignItems = "center";

                        // Adicionar um ícone ao lado do preço
                        const precoIcon = document.createElement("i");
                        precoIcon.classList.add("fas", "fa-tag"); // Ícone de etiqueta de preço
                        precoIcon.style.color = "#27ae60";
                        precoIcon.style.marginRight = "8px";

                        precoElemento.prepend(precoIcon); // Adicionar o ícone antes do texto
                        li.appendChild(precoElemento);
                    } else {
                        console.error("O preço recuperado não é um número válido.");
                    }

                    // Adicionar a localização com um ícone ao início
                    if (data.localizacao) {
                        const localizacaoContainer = document.createElement("div");
                        localizacaoContainer.style.display = "flex";
                        localizacaoContainer.style.alignItems = "center";
                        localizacaoContainer.style.marginBottom = "10px";

                        // Ícone de localização
                        const icon = document.createElement("i");
                        icon.className = "fa fa-map-marker-alt"; // Classe Font Awesome para o ícone
                        icon.style.marginRight = "5px";
                        icon.style.color = "#ff5733"; // Cor para destaque
                        icon.style.fontSize = "18px";
                        localizacaoContainer.appendChild(icon);

                        // Texto de localização
                        const localizacaoText = document.createElement("span");
                        localizacaoText.textContent = data.localizacao;
                        localizacaoText.style.fontSize = "14px";
                        localizacaoText.style.color = "#555";
                        localizacaoContainer.appendChild(localizacaoText);

                        // Adicionar ao início do elemento `li`
                        li.insertBefore(localizacaoContainer, li.firstChild);
                    }

                    // Adicionar data e hora da publicação
                    const dataHora = document.createElement("p");
                    dataHora.textContent = `Data e Hora: ${dataFormatada}`;
                    dataHora.style.fontSize = "12px";
                    dataHora.style.color = "#999";
                    dataHora.style.display = "flex";
                    dataHora.style.alignItems = "center";

                    // Adicionar um ícone ao lado da data e hora
                    const dataHoraIcon = document.createElement("i");
                    dataHoraIcon.classList.add("fas", "fa-clock"); // Ícone de relógio
                    dataHoraIcon.style.color = "#999";
                    dataHoraIcon.style.marginRight = "8px";

                    dataHora.prepend(dataHoraIcon); // Adicionar o ícone antes do texto
                    li.appendChild(dataHora);

                    // Adicionar a imagem da publicação
                    if (data.imagemUrl) {
                        const imagem = document.createElement("img");
                        imagem.src = data.imagemUrl;
                        imagem.alt = "Imagem da publicação";
                        imagem.style.width = "100%";
                        imagem.style.height = "auto";
                        imagem.style.borderRadius = "4px";
                        imagem.style.marginTop = "10px";
                        imagem.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
                        imagem.style.transition = "transform 0.5s ease";  // Transição suave
                        imagem.style.transform = "perspective(1000px) translateZ(0px) scale(1)";
                        imagem.loading = "lazy";

                        // Efeito de "hover" para que a imagem "saia para fora" e aumente de tamanho
                        imagem.addEventListener("mouseenter", () => {
                            imagem.style.transform = "perspective(1000px) translateZ(50px) scale(1.1)";
                        });

                        imagem.addEventListener("mouseleave", () => {
                            imagem.style.transform = "perspective(1000px) translateZ(0px) scale(1)";
                        });

                        li.appendChild(imagem);
                    }

                    // Adicionar botão de excluir publicação (se for o próprio usuário)
                    if (auth.currentUser && auth.currentUser.uid === data.userId) {
                        const deleteButton = document.createElement("button");
                        deleteButton.innerHTML = '<i class="fa fa-trash"></i>';
                        deleteButton.style.backgroundColor = "#e74c3c";
                        deleteButton.style.border = "none";
                        deleteButton.style.color = "#fff";
                        deleteButton.style.padding = "8px 12px";
                        deleteButton.style.borderRadius = "4px";
                        deleteButton.style.cursor = "pointer";
                        deleteButton.style.fontSize = "14px";
                        deleteButton.style.position = "absolute";
                        deleteButton.style.top = "10px";
                        deleteButton.style.right = "10px";
                        deleteButton.onclick = () => deletePost(doc.id, data.userId);
                        li.appendChild(deleteButton);
                    }

                    // Botão de Checkout
                    const checkoutButton = document.createElement("button");
                    checkoutButton.innerHTML = '<i class="fas fa-clock"></i> Agendar Serviço';
                    checkoutButton.style.backgroundColor = "#2ecc71";
                    checkoutButton.style.color = "#fff";
                    checkoutButton.style.border = "none";
                    checkoutButton.style.padding = "14px 20px"; // Mais espaçamento
                    checkoutButton.style.borderRadius = "6px";
                    checkoutButton.style.cursor = "pointer";
                    checkoutButton.style.fontSize = "18px"; // Fonte maior para destaque
                    checkoutButton.style.marginTop = "15px"; // Distância dos outros elementos
                    checkoutButton.style.width = "100%"; // Largura total
                    checkoutButton.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
                    checkoutButton.style.transition = "all 0.3s ease";
                    checkoutButton.onclick = () => openCheckoutModal(doc.id, data);

                    // Adicionar o botão de checkout no final
                    li.appendChild(document.createElement("br")); // Quebra de linha para organizar visualmente
                    li.appendChild(checkoutButton);

                    // Adicionar botão de like
                    const likeButton = document.createElement("button");
                    likeButton.id = `likeButton_${doc.id}`;
                    likeButton.innerHTML = '<i class="fa fa-thumbs-up"></i>';
                    likeButton.style.backgroundColor = "#3498db";
                    likeButton.style.border = "none";
                    likeButton.style.color = "#fff";
                    likeButton.style.padding = "10px 16px";
                    likeButton.style.borderRadius = "6px";
                    likeButton.style.cursor = "pointer";
                    likeButton.style.fontSize = "16px";
                    likeButton.style.marginRight = "10px";
                    likeButton.style.boxShadow = "0 4px 8px rgba(0,0,0,0.2)";
                    likeButton.style.transition = "all 0.3s ease";
                    likeButton.style.position = "relative";
                    likeButton.onclick = () => {
                        likePost(doc.id);
                        likeButton.style.transform = "scale(0.95)";
                        setTimeout(() => likeButton.style.transform = "scale(1)", 100);
                    };
                    li.appendChild(likeButton);

                    // Exibir contador de likes
                    // Exibir contador de likes
                    const likeCount = document.createElement("span");
                    likeCount.id = `likeCount_${doc.id}`; // Adicionando ID ao likeCount
                    likeCount.textContent = data.likes || 0;
                    Object.assign(likeCount.style, {
                        fontSize: "14px",
                        fontWeight: "bold",
                        color: "#3498db", // Cor azul para os likes
                        position: "absolute",
                        top: "5px",
                        left: "65%",
                        backgroundColor: "#f1f1f1",
                        borderRadius: "50%",
                        width: "24px",
                        height: "24px",
                        display: "flex",
                        justifyContent: "center",
                        alignItems: "center",
                        boxShadow: "0 2px 5px rgba(0, 0, 0, 0.2)",
                        transition: "transform 0.3s ease, background-color 0.3s ease",
                    });

                    // Animação visual ao alterar o contador de likes (seu sistema pode acionar isso conforme a lógica já existente)
                    function animateLikeCounter() {
                        likeCount.style.transform = "scale(1.2)";
                        setTimeout(() => {
                            likeCount.style.transform = "scale(1)";
                        }, 200);
                    }

                    likeButton.appendChild(likeCount);

                    // Adicionar botão de mostrar comentários
                    const showCommentsButton = document.createElement("button");
                    showCommentsButton.innerHTML = '<i class="fa fa-comments"></i>';
                    showCommentsButton.style.backgroundColor = "#2ecc71";
                    showCommentsButton.style.border = "none";
                    showCommentsButton.style.color = "#fff";
                    showCommentsButton.style.padding = "10px 16px";
                    showCommentsButton.style.borderRadius = "6px";
                    showCommentsButton.style.cursor = "pointer";
                    showCommentsButton.style.fontSize = "16px";
                    showCommentsButton.style.marginLeft = "10px";
                    showCommentsButton.style.boxShadow = "0 4px 8px rgba(0,0,0,0.2)";
                    showCommentsButton.style.transition = "all 0.3s ease";
                    showCommentsButton.style.position = "relative";
                    showCommentsButton.onclick = () => {
                        showComments(doc.id);
                        showCommentsButton.style.transform = "scale(0.95)";
                        setTimeout(() => showCommentsButton.style.transform = "scale(1)", 100);
                    };
                    li.appendChild(showCommentsButton);

                    // Exibir contador de comentários
                    const commentCount = document.createElement("span");
                    commentCount.textContent = data.comments || 0;
                    Object.assign(commentCount.style, {
                        fontSize: "14px",
                        fontWeight: "bold",
                        color: "#2ecc71", // Cor verde para os comentários
                        position: "absolute",
                        top: "5px",
                        left: "65%",
                        backgroundColor: "#f1f1f1",
                        borderRadius: "50%",
                        width: "24px",
                        height: "24px",
                        display: "flex",
                        justifyContent: "center",
                        alignItems: "center",
                        boxShadow: "0 2px 5px rgba(0, 0, 0, 0.2)",
                        transition: "transform 0.3s ease, background-color 0.3s ease",
                    });

                    // Animação visual ao alterar o contador de comentários (seu sistema pode acionar isso conforme a lógica já existente)
                    function animateCommentCounter() {
                        commentCount.style.transform = "scale(1.2)";
                        setTimeout(() => {
                            commentCount.style.transform = "scale(1)";
                        }, 200);
                    }

                    showCommentsButton.appendChild(commentCount);

                    // Botão de Mensagem
                    const comprarButton = document.createElement("button");
                    comprarButton.innerHTML = '<i class="fas fa-comment-dots"></i>Chat';
                    comprarButton.style.backgroundColor = "#e67e22";
                    comprarButton.style.border = "none";
                    comprarButton.style.color = "#fff";
                    comprarButton.style.padding = "10px 16px";
                    comprarButton.style.borderRadius = "6px";
                    comprarButton.style.cursor = "pointer";
                    comprarButton.style.fontSize = "16px";
                    comprarButton.style.marginLeft = "10px";
                    comprarButton.style.boxShadow = "0 4px 8px rgba(0,0,0,0.2)";
                    comprarButton.style.transition = "all 0.3s ease";
                    comprarButton.style.display = "none";
                    comprarButton.onclick = () => {
                        iniciarCompra(data.userId, auth.currentUser.uid, data);
                        comprarButton.style.transform = "scale(0.95)";
                        setTimeout(() => comprarButton.style.transform = "scale(1)", 100);
                    };
                    li.appendChild(comprarButton);

                    // Botão Ver Mais
                    const verMaisButton = document.createElement("button");
                    verMaisButton.innerHTML = '<i class="fas fa-plus"></i> info';
                    verMaisButton.style.backgroundColor = "#3498db";
                    verMaisButton.style.color = "#fff";
                    verMaisButton.style.border = "none";
                    verMaisButton.style.padding = "10px 16px";
                    verMaisButton.style.borderRadius = "6px";
                    verMaisButton.style.cursor = "pointer";
                    verMaisButton.style.fontSize = "16px";
                    verMaisButton.style.marginTop = "10px";
                    verMaisButton.style.boxShadow = "0 4px 8px rgba(0,0,0,0.2)";
                    verMaisButton.style.transition = "all 0.3s ease";
                    verMaisButton.onclick = () => {
                        showDetalhesAnuncio(data);
                        verMaisButton.style.transform = "scale(0.95)";
                        setTimeout(() => verMaisButton.style.transform = "scale(1)", 100);
                    };
                    li.appendChild(verMaisButton);

                    // Criar o container para os botões
                    const buttonContainer = document.createElement("div");
                    buttonContainer.style.display = "flex";
                    buttonContainer.style.gap = "2%"; // Espaçamento entre os botões
                    buttonContainer.style.marginTop = "15px"; // Distância dos elementos acima
                    buttonContainer.style.justifyContent = "center"; // Centralizar os botões no container

                    // Definir estilo comum para os botões
                    const buttonStyle = {
                        color: "#fff",
                        border: "none",
                        padding: "10px 16px",
                        borderRadius: "6px",
                        cursor: "pointer",
                        fontSize: "16px",
                        boxShadow: "0 4px 8px rgba(0, 0, 0, 0.2)",
                        transition: "transform 0.3s ease, box-shadow 0.3s ease", // Animações
                        flex: "1 1 25%",  // Ajusta o tamanho dos botões para ocupar até 25% da largura
                        minWidth: "20%",  // Garantir que os botões não fiquem muito pequenos
                        maxWidth: "140px",  // Limitar a largura máxima para que os botões não fiquem enormes
                    };

                    // Animação ao passar o mouse
                    const hoverStyle = {
                        transform: "scale(1.05)", // Aumenta o tamanho do botão ao passar o mouse
                        boxShadow: "0 6px 12px rgba(0, 0, 0, 0.3)", // Sombra mais forte
                    };

                    // Função para adicionar animações de hover
                    function applyHoverAnimation(button) {
                        button.addEventListener("mouseenter", () => {
                            Object.assign(button.style, hoverStyle); // Aplica o estilo de hover
                        });
                        button.addEventListener("mouseleave", () => {
                            Object.assign(button.style, buttonStyle); // Volta ao estilo normal
                        });
                    }

                    // Aplicar estilo aos botões
                    Object.assign(likeButton.style, buttonStyle);
                    Object.assign(showCommentsButton.style, { ...buttonStyle, backgroundColor: "#2ecc71" });
                    Object.assign(comprarButton.style, { ...buttonStyle, backgroundColor: "#e67e22" });
                    Object.assign(verMaisButton.style, buttonStyle);

                    // Adicionar animações de hover nos botões
                    applyHoverAnimation(likeButton);
                    applyHoverAnimation(showCommentsButton);
                    applyHoverAnimation(comprarButton);
                    applyHoverAnimation(verMaisButton);

                    // Adicionar os botões ao container
                    buttonContainer.appendChild(likeButton);
                    buttonContainer.appendChild(showCommentsButton);
                    buttonContainer.appendChild(comprarButton);
                    buttonContainer.appendChild(verMaisButton);

                    // Adicionar o container ao elemento principal
                    li.appendChild(buttonContainer);

                    // Adicionar regras de mídia para telas menores
                    const mediaQuery = window.matchMedia("(max-width: 600px)"); // Para telas menores que 600px
                    function adjustButtonLayout() {
                        if (mediaQuery.matches) {
                            // Em telas menores, ainda manter os botões lado a lado e ajustados
                            buttonContainer.style.flexDirection = "row"; // Garante que os botões fiquem lado a lado
                            buttonContainer.style.justifyContent = "center"; // Centraliza os botões
                        } else {
                            // Para telas maiores, pode aumentar o espaçamento ou ajustar o layout
                            buttonContainer.style.flexDirection = "row"; // Garante que os botões fiquem lado a lado
                            buttonContainer.style.justifyContent = "space-between"; // Dá mais espaço entre os botões
                        }
                    }

                    // Ajusta o layout ao carregar a página
                    adjustButtonLayout();

                    // Atualiza o layout ao redimensionar a tela
                    mediaQuery.addEventListener("change", adjustButtonLayout);

                    // Div para exibir os comentários
                    const commentsDiv = document.createElement("div");
                    commentsDiv.id = `comments_${doc.id}`;
                    commentsDiv.style.display = "none";
                    commentsDiv.style.marginTop = "10px";
                    li.appendChild(commentsDiv);

                    // Textarea para adicionar comentário
                    const commentText = document.createElement("textarea");
                    commentText.id = `commentText_${doc.id}`;
                    commentText.placeholder = "Digite seu comentário";
                    Object.assign(commentText.style, {
                        resize: "none",
                        width: "calc(100% - 20px)",
                        height: "75px", // Altura suficiente para comentários
                        padding: "10px",
                        borderRadius: "8px",
                        border: "1px solid #ccc",
                        boxShadow: "0 2px 5px rgba(0, 0, 0, 0.1)",
                        fontSize: "14px",
                        lineHeight: "1.5",
                        fontFamily: "'Arial', sans-serif",
                        color: "#333",
                        backgroundColor: "#f9f9f9",
                        outline: "none",
                        transition: "border-color 0.3s ease, box-shadow 0.3s ease",
                    });

                    // Adicionar estilo ao focar na textarea
                    commentText.addEventListener("focus", () => {
                        commentText.style.borderColor = "#3498db"; // Azul claro
                        commentText.style.boxShadow = "0 3px 8px rgba(52, 152, 219, 0.2)";
                    });

                    commentText.addEventListener("blur", () => {
                        commentText.style.borderColor = "#ccc";
                        commentText.style.boxShadow = "none";
                    });

                    li.appendChild(commentText);

                    // Botão para adicionar comentário
                    const addCommentButton = document.createElement("button");
                    addCommentButton.textContent = "Adicionar Comentário";
                    Object.assign(addCommentButton.style, {
                        display: "block",
                        marginTop: "10px",
                        padding: "10px 16px",
                        borderRadius: "8px",
                        border: "none",
                        fontSize: "16px",
                        fontWeight: "bold",
                        color: "#fff",
                        backgroundColor: "#3498db",
                        cursor: "pointer",
                        boxShadow: "0 4px 8px rgba(0, 0, 0, 0.2)",
                        transition: "background-color 0.3s ease, box-shadow 0.3s ease",
                    });

                    // Efeito ao passar o mouse sobre o botão
                    addCommentButton.addEventListener("mouseenter", () => {
                        addCommentButton.style.backgroundColor = "#2a80b9"; // Tom mais escuro de azul
                        addCommentButton.style.boxShadow = "0 6px 12px rgba(0, 0, 0, 0.3)";
                    });

                    addCommentButton.addEventListener("mouseleave", () => {
                        addCommentButton.style.backgroundColor = "#3498db";
                        addCommentButton.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
                    });

                    // Função onclick para o botão
                    addCommentButton.onclick = () => addComment(doc.id);

                    li.appendChild(addCommentButton);

                    // Adicionar o li à linha do tempo do usuário
                    userTimeline.appendChild(li);

                    // Exibir o contador de comentários
                    const comentariosRef = collection(db, `publicacoes/${doc.id}/comentarios`);
                    const comentariosSnapshot = await getDocs(comentariosRef);
                    commentCount.textContent = comentariosSnapshot.size; // Atualiza o total de comentários

                    // Adicionar botão de denúncia
                    const reportButton = document.createElement("button");
                    reportButton.innerHTML = '<i class="fa fa-exclamation-triangle"></i>';
                    reportButton.innerHTML = '<i class="fa fa-flag"></i>';
                    reportButton.style.backgroundColor = "#e74c3c";
                    reportButton.style.border = "none";
                    reportButton.style.color = "#fff";
                    reportButton.style.padding = "8px 12px";
                    reportButton.style.borderRadius = "4px";
                    reportButton.style.cursor = "pointer";
                    reportButton.style.fontSize = "14px";
                    reportButton.style.position = "absolute";
                    reportButton.style.bottom = "10px";
                    reportButton.style.right = "10px";
                    reportButton.id = `reportButton_${doc.id}`;
                    reportButton.onclick = () => reportPost(doc.id);
                    li.appendChild(reportButton);

                    // Adiciona um evento de clique para exibir o perfil do usuário ao clicar na foto ou no nome
                    userImg.onclick = () => showUserProfile(data.userId);
                    userName.onclick = () => showUserProfile(data.userId);

                    addLoadMoreButton();

                    filterPostsBySearch();
                });

                // Verificar se há mais documentos a serem carregados
                if (!isInitialLoad || querySnapshot.size === pageSize) {
                    addLoadMoreButton();
                }
            } catch (error) {
                console.error("Erro ao obter a linha do tempo:", error);
            }
            finally {
                isFetching = false;
            }
        }

        // Função para adicionar o botão de "Carregar Mais"
        function addLoadMoreButton() {
            const userTimeline = document.getElementById("userTimeline");
            let loadMoreButton = document.getElementById("loadMoreButton");

            if (!loadMoreButton) {
                loadMoreButton = document.createElement("button");
                loadMoreButton.id = "loadMoreButton";
                loadMoreButton.textContent = "Carregar Mais";
                loadMoreButton.onclick = () => getAllUserTimeline(false); // Chama a função para carregar mais
            }

            // Move o botão para o final do container
            userTimeline.appendChild(loadMoreButton);
        }

        function openCheckoutModal(docId, data) {
            const modal = document.createElement("div");
            Object.assign(modal.style, {
                position: "fixed",
                top: "0",
                left: "0",
                width: "100%",
                height: "100%",
                backgroundColor: "rgba(0, 0, 0, 0.6)",
                display: "flex",
                justifyContent: "center",
                alignItems: "center",
                zIndex: "1000",
                animation: "fadeIn 0.3s ease",
                overflowY: "auto",
            });

            const modalContent = document.createElement("div");
            Object.assign(modalContent.style, {
                backgroundColor: "#fff",
                padding: "20px",
                borderRadius: "12px",
                boxShadow: "0 8px 16px rgba(0, 0, 0, 0.3)",
                textAlign: "center",
                width: "90%",
                maxWidth: "400px",
                height: "auto",
                transform: "scale(0.8)",
                animation: "scaleUp 0.3s ease forwards",
                position: "relative",
            });

            // Botão de fechamento "X"
            const closeButton = document.createElement("span");
            closeButton.innerHTML = "&times;";
            Object.assign(closeButton.style, {
                position: "absolute",
                top: "5px",
                right: "4px",
                fontSize: "40px",
                color: "#e74c3c",
                cursor: "pointer",
            });

            closeButton.onclick = () => closeModal(modal);

            modalContent.innerHTML = `
                <div style="text-align: left; margin-bottom: 20px;">
                <img src="${data.imagemUrl}" alt="Miniatura do Anúncio" style="width: 100%; height: auto; max-height: 200px; border-radius: 8px; margin-bottom: 10px;" />
                <p style="font-size: 16px; color: #7f8c8d; margin-bottom: 5px;">${data.mensagem}</p>
                <p style="font-size: 16px; color: #27ae60; font-weight: bold;">Preço: R$ ${data.preco}</p>
            </div>
            <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #34495e;">Data:</label>
            <input type="date" id="serviceDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;" required />
            <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #34495e;">Hora:</label>
            <input type="time" id="serviceTime" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px;" required />
            <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #34495e;">Local:</label>
            <label style="display: block; font-size: 14px; margin-bottom: 5px; color: #34495e;"></label>
            <input type="text" id="serviceLocation" placeholder="Digite o local" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px;" required />
            <input type="hidden" id="locationLat" />
            <input type="hidden" id="locationLng" />

            <button id="confirmCheckout" style="
                background-color: #2ecc71; 
                color: #fff; 
                border: none; 
                padding: 12px 20px; 
                border-radius: 6px; 
                cursor: pointer; 
                width: 100%; 
                font-size: 16px;
                transition: background-color 0.3s ease;
            ">Confirmar</button>`;

            modalContent.appendChild(closeButton); // Adiciona o botão de fechar no conteúdo
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Configurar Autocomplete no campo de localização
            const locationInput = document.getElementById("serviceLocation");
            const autocomplete = new google.maps.places.Autocomplete(locationInput, {
                types: ["geocode"],
                componentRestrictions: { country: "br" }, // Restringe a busca ao Brasil
            });

            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    alert("Por favor, selecione um local válido.");
                    return;
                }
                document.getElementById("locationLat").value = place.geometry.location.lat();
                document.getElementById("locationLng").value = place.geometry.location.lng();
            });

            // Botão Confirmar
            document.getElementById("confirmCheckout").onclick = () => {
                const date = document.getElementById("serviceDate").value;
                const time = document.getElementById("serviceTime").value;
                const location = document.getElementById("serviceLocation").value;
                const lat = document.getElementById("locationLat").value;
                const lng = document.getElementById("locationLng").value;

                if (date && time && location && lat && lng) {
                    const locationData = {
                        address: location,
                        lat: parseFloat(lat),
                        lng: parseFloat(lng),
                    };
                    confirmCheckout(docId, data, date, time, locationData);
                    closeModal(modal);
                } else {
                    alert("Preencha todos os campos corretamente!");
                }
            };

            // Adicionar keyframes
            addKeyframes();
        }

        // Função para fechar o modal
        function closeModal(modal) {
            if (modal) {
                modal.style.animation = "fadeOut 0.3s ease";
                setTimeout(() => {
                    if (modal.parentElement) {
                        modal.parentElement.removeChild(modal);
                    }
                }, 300);
            }
        }

        // Função para adicionar keyframes
        function addKeyframes() {
            const styleSheet = document.styleSheets[0];
            styleSheet.insertRule(`
                @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }`,
                styleSheet.cssRules.length);
            styleSheet.insertRule(`
                @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }`,
                styleSheet.cssRules.length);
            styleSheet.insertRule(`
                @keyframes scaleUp {
                from { transform: scale(0.8); }
                to { transform: scale(1); }
            }`,
                styleSheet.cssRules.length);
        }

        async function confirmCheckout(docId, data, date, time, location) {
            const buyerUid = auth.currentUser.uid;
            const sellerUid = data.userId;

            // Gerar número de pedido randômico de 6 dígitos
            const numeroPedido = `#${Math.floor(100000 + Math.random() * 900000)}`;

            const agendamento = {
                buyerUid,
                sellerUid,
                anuncioId: docId,
                descricao: data.descricao,
                preco: data.preco,
                imagemUrl: data.imagemUrl, // Adicionando a URL da imagem
                numeroPedido, // Adicionando o número de pedido
                date,
                time,
                location,
                status: "pendente", // Pendente, confirmado, concluído
                createdAt: new Date(),
            };

            try {
                await addDoc(collection(db, "agendamentos"), agendamento);
                alert("Serviço agendado com sucesso!");
            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                alert("Ocorreu um erro ao agendar o serviço. Tente novamente.");
            }
        }

        let nonCompletedOrdersCount = 0;

        async function displayOrders() {
            const userUid = auth.currentUser.uid;

            try {
                // Atualizar o contador de pedidos não concluídos
                await updateOrdersCounter();

                const buyerOrdersSnapshot = await getDocs(query(collection(db, "agendamentos"), where("buyerUid", "==", userUid)));
                const sellerOrdersSnapshot = await getDocs(query(collection(db, "agendamentos"), where("sellerUid", "==", userUid)));

                const allOrders = [...buyerOrdersSnapshot.docs, ...sellerOrdersSnapshot.docs];

                allOrders.sort((a, b) => b.data().timestamp - a.data().timestamp);

                // Redefinir o contador de pedidos não concluídos
                nonCompletedOrdersCount = 0;

                // Verificar e contar os pedidos não concluídos
                allOrders.forEach((docSnap) => {
                    const order = docSnap.data();
                    if (order.status !== "concluido") {
                        nonCompletedOrdersCount++;
                    }
                });

                // Atualizar o contador no botão
                const ordersCounter = document.getElementById("ordersCounter");
                ordersCounter.textContent = nonCompletedOrdersCount;
                ordersCounter.style.display = nonCompletedOrdersCount > 0 ? "inline-block" : "none";

                const ordersContainer = document.getElementById("ordersContainer");
                ordersContainer.innerHTML = "";

                const statusDescriptions = {
                    pendente: "Aguardando prestador aceitar o pedido",
                    "pedido aceito": "Pedido aceito, aguardando data para o serviço",
                    indo: "Prestador indo para o local",
                    cheguei: "Prestador chegou ao local",
                    concluido: "Serviço concluído"
                };

                for (const docSnap of allOrders) {
                    const order = docSnap.data();
                    const isSeller = order.sellerUid === userUid;

                    const buyerRef = doc(db, "users", order.buyerUid);
                    const sellerRef = doc(db, "users", order.sellerUid);

                    const buyerUser = await getDoc(buyerRef);
                    const sellerUser = await getDoc(sellerRef);

                    const buyerPhoto = buyerUser.exists() ? buyerUser.data().photoURL : "";
                    const sellerPhoto = sellerUser.exists() ? sellerUser.data().photoURL : "";
                    const buyerName = buyerUser.exists() ? buyerUser.data().fullName : "Cliente";
                    const sellerName = sellerUser.exists() ? sellerUser.data().fullName : "Prestador";

                    const orderCard = document.createElement("div");
                    orderCard.style.cssText = `
                        border: 1px solid #ddd;
                        border-radius: 10px;
                        margin: 15px 0;
                        padding: 20px;
                        background-color: #fff;
                        box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
                        font-family: Arial, sans-serif;
                    `;

                    const title = document.createElement("h3");
                    title.textContent = order.descricao;
                    title.style.cssText = "color: #333; font-size: 18px; margin-bottom: 10px;";
                    orderCard.appendChild(title);

                    const time = new Date(order.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const info = document.createElement("p");
                    info.textContent = `Preço: R$${order.preco} | Data: ${formatDate(order.date)} | Hora: ${order.time} | Local: ${order.location ? order.location.address : "Endereço não disponível"}`;
                    info.style.cssText = "color: #555; font-size: 14px; margin-bottom: 15px;";
                    orderCard.appendChild(info);

                    const userPhoto = document.createElement("div");
                    userPhoto.innerHTML = `
                        <img src="${isSeller ? buyerPhoto : sellerPhoto}" alt="Foto" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">
                        <span style="font-weight: bold; color: #444;">${isSeller ? buyerName : sellerName}</span>
                        <p style="color: #888; font-size: 12px;">${isSeller ? "Cliente" : "Prestador"}</p>
                    `;
                    userPhoto.style.cssText = `display: flex; align-items: center; margin: 10px 0;`;
                    orderCard.appendChild(userPhoto);

                    const statusHistory = document.createElement("div");
                    const statuses = ["pendente", "pedido aceito", "indo", "cheguei", "concluido"];
                    statuses.forEach((status, index) => {
                        if (index <= statuses.indexOf(order.status)) {
                            const statusItem = document.createElement("div");
                            statusItem.style.cssText = `
                                display: flex;
                                align-items: center;
                                margin: 5px 0;
                                font-size: 14px;
                                font-weight: bold;
                                color: ${order.status === status ? "#ffc107" : "#28a745"};
                            `;

                            // Ícone
                            const icon = document.createElement("span");
                            icon.style.cssText = `
                                width: 16px;
                                height: 16px;
                                margin-right: 8px;
                                display: inline-block;
                                border-radius: 50%;
                                background-color: ${order.status === status ? "#ffc107" : "#28a745"};
                            `;

                            // Texto do status
                            const statusText = document.createElement("span");
                            statusText.textContent = statusDescriptions[status];

                            statusItem.appendChild(icon);
                            statusItem.appendChild(statusText);
                            statusHistory.appendChild(statusItem);
                        }
                    });
                    orderCard.appendChild(statusHistory);

                    if (isSeller) {
                        if (order.status === "pendente") {
                            createButton(orderCard, "Aceitar Pedido", "#28a745", async () => {
                                await updateDoc(docSnap.ref, { status: "pedido aceito" });
                                displayOrders();
                            });
                        } else if (order.status === "pedido aceito") {
                            createButton(orderCard, "Indo para o Local", "#007bff", async () => {
                                await updateDoc(docSnap.ref, { status: "indo" });
                                displayOrders();
                            });
                        } else if (order.status === "indo") {
                            createButton(orderCard, "Cheguei ao Cliente", "#17a2b8", async () => {
                                await updateDoc(docSnap.ref, { status: "cheguei" });
                                displayOrders();
                            });
                        } else if (order.status === "cheguei") {
                            createButton(orderCard, "Serviço Concluído", "#ffc107", async () => {
                                try {
                                    // Obter a data e hora atuais no fuso horário de Brasília
                                    const now = new Date();
                                    const brasiliaTime = new Intl.DateTimeFormat("pt-BR", {
                                        timeZone: "America/Sao_Paulo",
                                        day: "2-digit",
                                        month: "2-digit",
                                        year: "numeric",
                                        hour: "2-digit",
                                        minute: "2-digit",
                                    }).format(now);

                                    // Salvar no Firestore
                                    await updateDoc(docSnap.ref, {
                                        status: "concluido",
                                        completedAt: new Date(now) // Salvar como timestamp
                                    });

                                    displayOrders();
                                } catch (error) {
                                    console.error("Erro ao atualizar o documento:", error);
                                    alert("Não foi possível salvar a hora de conclusão.");
                                }
                            });
                        }
                    } else {
                        if (order.status === "pendente") {
                            createButton(orderCard, "Cancelar Pedido", "#dc3545", async () => {
                                await deleteDoc(docSnap.ref);
                                displayOrders();
                            });
                        }
                    }

                    const chatButton = document.createElement("button");
                    chatButton.textContent = "Chat";
                    chatButton.style.cssText = `
                        background-color: #007bff;
                        color: white;
                        border: none;
                        border-radius: 5px;
                        padding: 10px;
                        cursor: pointer;
                        font-size: 14px;
                        margin-right: 10px;
                    `;
                    chatButton.onclick = async () => {
                        const otherUserUid = isSeller ? order.buyerUid : order.sellerUid;
                        const produto = { descricao: order.descricao, preco: order.preco };

                        try {
                            // Verificar se o chat já existe
                            const existingChatQuery = query(
                                collection(db, "chats"),
                                where("vendedorId", "in", [userUid, otherUserUid]),
                                where("compradorId", "in", [userUid, otherUserUid]),
                                where("produto.descricao", "==", produto.descricao)
                            );
                            const existingChatSnapshot = await getDocs(existingChatQuery);

                            if (!existingChatSnapshot.empty) {
                                // Abrir o chat existente
                                const existingChat = existingChatSnapshot.docs[0];
                                openChat(existingChat.id, produto.descricao);
                                // Trocar para a aba de notificações
                                showTab('notificacoes');
                                console.log("Chat existente aberto:", existingChat.id);
                            } else {
                                // Criar um novo chat se não existir
                                iniciarCompra(userUid, otherUserUid, produto);
                            }
                        } catch (error) {
                            console.error("Erro ao verificar ou iniciar o chat:", error);
                        }
                    };

                    orderCard.appendChild(chatButton);

                    ordersContainer.appendChild(orderCard);
                }
            } catch (error) {
                console.error("Erro ao buscar pedidos:", error);
                alert("Erro ao carregar os pedidos.");
            }
        }

        function createButton(parent, text, color, onClick) {
            const button = document.createElement("button");
            button.textContent = text;
            button.style.cssText = `
                background-color: ${color};
                color: white;
                border: none;
                border-radius: 4px;
                padding: 10px 15px;
                cursor: pointer;
                margin: 5px;
            `;
            button.onclick = onClick;
            parent.appendChild(button);
        }

        async function updateOrdersCounter() {
            const userUid = auth.currentUser.uid;

            try {
                const buyerOrdersSnapshot = await getDocs(query(collection(db, "agendamentos"), where("buyerUid", "==", userUid)));
                const sellerOrdersSnapshot = await getDocs(query(collection(db, "agendamentos"), where("sellerUid", "==", userUid)));

                const allOrders = [...buyerOrdersSnapshot.docs, ...sellerOrdersSnapshot.docs];

                // Contar os pedidos não concluídos
                const nonCompletedOrdersCount = allOrders.filter(docSnap => docSnap.data().status !== "concluido").length;

                // Atualizar o contador no botão
                const ordersCounter = document.getElementById("ordersCounter");
                ordersCounter.textContent = nonCompletedOrdersCount;
                ordersCounter.style.display = nonCompletedOrdersCount > 0 ? "inline-block" : "none";
            } catch (error) {
                console.error("Erro ao atualizar contador de pedidos:", error);
            }
        }

        function formatDate(date) {
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');  // Adiciona zero à esquerda se necessário
            const month = String(d.getMonth() + 1).padStart(2, '0');  // Mês começa do 0 (Janeiro) então somamos 1
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }

        async function displayFinancialHistory() {
            const userUid = auth.currentUser.uid;

            try {
                const sellerOrdersSnapshot = await getDocs(
                    query(
                        collection(db, "agendamentos"),
                        where("sellerUid", "==", userUid),
                        where("status", "==", "concluido")
                    )
                );

                const orders = [];
                sellerOrdersSnapshot.forEach((docSnap) => {
                    const order = { ...docSnap.data(), id: docSnap.id };
                    orders.push(order);
                });

                const financialContainer = document.getElementById("financialContainer");
                financialContainer.innerHTML = `
        <div style="font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; border-radius: 12px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="color: #333; font-size: 20px; font-weight: bold;">
                        <i style="color: #4caf50;" class="fas fa-wallet"></i> Total Líquido
                    </h2>
                </div>
                <div style="position: relative;">
                    <span id="toggleBalance" style="cursor: pointer; font-size: 18px; color: #888;">
                        <i id="eyeIcon" class="fas fa-eye"></i>
                    </span>
                    <span id="balance" style="font-size: 24px; font-weight: bold; color: #4caf50; margin-left: 10px;">R$ *****,**</span>
                </div>
            </div>
            <div style="text-align: center; font-size: 18px; font-weight: bold; color: #333; margin-bottom: 20px;">
                <p id="totalBrutoWrapper">Total Bruto: <span id="totalBruto" style="color: #4caf50;">R$ 0,00</span></p>
                <p id="totalComissaoWrapper">Comissão: <span id="totalComissao" style="color: #e53935;">R$ 0,00</span></p>
                <p id="totalLiquidoWrapper" style="display: none;">Total Líquido: <span id="totalLiquido" style="color: #2196f3;">R$ 0,00</span></p>
            </div>
            <div style="display: flex; justify-content: space-around; margin-bottom: 20px; flex-wrap: wrap;">
                <button id="filterToday" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">Hoje</button>
                <button id="filterWeek" style="padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer;">Semanal</button>
                <button id="filterMonth" style="padding: 10px 20px; background: #fbc02d; color: white; border: none; border-radius: 8px; cursor: pointer;">Mensal</button>
                <input type="date" id="startDate" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px;" />
                <input type="date" id="endDate" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px;" />
                <button id="filterCustom" style="padding: 10px 20px; background: #e91e63; color: white; border: none; border-radius: 8px; cursor: pointer;">Filtrar</button>
            </div>
            <div id="orderList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; background: #fff; border-radius: 8px;">
                <!-- Lista de pedidos será renderizada aqui -->
            </div>

            <button id="downloadPDF" style="padding: 10px 20px; background: #3f51b5; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                Baixar PDF
            </button>

        </div>
    `;

                const formatCurrency = (value) => {
                    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
                };

                const updateBalances = (filteredOrders) => {
                    let totalBruto = 0;
                    filteredOrders.forEach(order => {
                        totalBruto += parseFloat(order.preco || 0);
                    });
                    const totalComissao = totalBruto * 0.2;
                    const totalLiquido = totalBruto - totalComissao;

                    document.getElementById("totalBruto").textContent = formatCurrency(totalBruto);
                    document.getElementById("totalComissao").textContent = formatCurrency(totalComissao);
                    document.getElementById("totalLiquido").textContent = formatCurrency(totalLiquido);
                    document.getElementById("balance").textContent = formatCurrency(totalLiquido);
                };

                const renderOrders = (filteredOrders) => {
                    const orderList = document.getElementById("orderList");
                    orderList.innerHTML = "";
                    if (filteredOrders.length === 0) {
                        orderList.innerHTML = `<p style="text-align: center; color: #888;">Nenhum pedido concluído encontrado.</p>`;
                    } else {
                        filteredOrders.forEach(order => {
                            const value = parseFloat(order.preco || 0);
                            const comissao = value * 0.2;
                            const orderTime = dayjs(order.completedAt.toDate()).format('DD/MM/YYYY HH:mm');

                            const orderItem = document.createElement("div");
                            orderItem.style.padding = "15px";
                            orderItem.style.borderBottom = "1px solid #ddd";
                            orderItem.style.display = "flex";
                            orderItem.style.justifyContent = "space-between";
                            orderItem.style.alignItems = "center";

                            orderItem.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-money-bill-wave" style="font-size: 20px; color: #4caf50; margin-right: 10px;"></i>
                            <span style="font-size: 16px; color: #333;">Entrada</span>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size: 16px; font-weight: bold; color: #4caf50;">+${formatCurrency(value)}</span>
                            <div style="font-size: 14px; color: #e53935;">Comissão: -${formatCurrency(comissao)}</div>
                            <div style="font-size: 14px; color: #888;">Data: ${orderTime}</div>
                        </div>
                    `;
                            orderList.appendChild(orderItem);
                        });
                    }
                    updateBalances(filteredOrders);
                };

                // Carregar o plugin isBetween
                dayjs.extend(dayjs_plugin_isBetween);

                const filterOrders = (startDate, endDate) => {
                    const filteredOrders = orders.filter((order) => {
                        // Converte o timestamp para objeto Date antes de usar com dayjs
                        const orderDate = dayjs(order.completedAt.toDate()); // Converte para Date
                        if (!orderDate.isValid()) {
                            console.error("Data inválida para o pedido:", order.completedAt);
                            return false; // Retorna false caso a data não seja válida
                        }
                        return orderDate.isBetween(startDate, endDate, null, '[]');
                    });
                    renderOrders(filteredOrders);
                };

                const downloadButton = document.getElementById("downloadPDF");

                if (downloadButton) {
                    downloadButton.addEventListener("click", () => {
                        generateFinancialReportPDF(orders, userUid);
                    });
                } else {
                    console.error("Botão 'downloadPDF' não encontrado no DOM.");
                }

                document.getElementById("filterToday").addEventListener("click", () => {
                    const today = dayjs().startOf('day');
                    filterOrders(today, today.endOf('day'));
                });

                document.getElementById("filterWeek").addEventListener("click", () => {
                    const startOfWeek = dayjs().startOf('week');
                    filterOrders(startOfWeek, dayjs());
                });

                document.getElementById("filterMonth").addEventListener("click", () => {
                    const startOfMonth = dayjs().startOf('month');
                    filterOrders(startOfMonth, dayjs());
                });

                document.getElementById("filterCustom").addEventListener("click", () => {
                    const startDate = dayjs(document.getElementById("startDate").value);
                    const endDate = dayjs(document.getElementById("endDate").value);
                    if (startDate.isValid() && endDate.isValid()) {
                        filterOrders(startDate.startOf('day'), endDate.endOf('day'));
                    } else {
                        alert("Selecione datas válidas.");
                    }
                });

                document.getElementById("toggleBalance").addEventListener("click", () => {
                    const balance = document.getElementById("balance");
                    const eyeIcon = document.getElementById("eyeIcon");

                    const totalBrutoWrapper = document.getElementById("totalBrutoWrapper");
                    const totalComissaoWrapper = document.getElementById("totalComissaoWrapper");

                    if (balance.textContent.includes("*****")) {
                        balance.textContent = document.getElementById("totalLiquido").textContent;
                        totalBrutoWrapper.style.display = "block"; // Exibir Total Bruto
                        totalComissaoWrapper.style.display = "block"; // Exibir Comissão
                        eyeIcon.className = "fas fa-eye-slash";
                    } else {
                        balance.textContent = "R$ *****";
                        totalBrutoWrapper.style.display = "none"; // Ocultar Total Bruto
                        totalComissaoWrapper.style.display = "none"; // Ocultar Comissão
                        eyeIcon.className = "fas fa-eye";
                    }
                });

                renderOrders(orders);
            } catch (error) {
                console.error("Erro ao carregar histórico financeiro:", error);
                alert("Erro ao carregar histórico financeiro.");
            }
        }

        async function generateFinancialReportPDF(orders, userId) {
            const { jsPDF } = window.jspdf;

            // Obtém o nome completo do usuário da coleção "users"
            const userDocRef = doc(db, "users", userId); // 'doc' do Firestore
            const userDocSnap = await getDoc(userDocRef);
            const userName = userDocSnap.exists() ? userDocSnap.data().fullName : "Usuário Desconhecido";

            // Filtra apenas os pedidos da última semana (domingo a sábado)
            const now = dayjs();
            const startOfWeek = now.startOf('week');
            const endOfWeek = now.endOf('week');
            const weeklyOrders = orders.filter(order => {
                const orderDate = dayjs(order.completedAt.toDate());
                return orderDate.isAfter(startOfWeek) && orderDate.isBefore(endOfWeek);
            });

            if (weeklyOrders.length === 0) {
                return; // Sai da função se não houver dados
            }

            // Configurações do relatório
            const pdfDoc = new jsPDF();
            const headers = ["Data", "Descrição", "Valor Bruto", "Comissão (20%)", "Valor Líquido"];
            const rows = weeklyOrders.map(order => {
                const value = parseFloat(order.preco || 0);
                const comissao = value * 0.2;
                const liquido = value - comissao;
                const date = dayjs(order.completedAt.toDate()).format('DD/MM/YYYY HH:mm');
                return [
                    date,
                    "Serviço concluído",
                    formatCurrency(value),
                    formatCurrency(comissao),
                    formatCurrency(liquido)
                ];
            });

            // Calcula os totais
            const totalBruto = weeklyOrders.reduce((sum, order) => sum + parseFloat(order.preco || 0), 0);
            const totalComissao = totalBruto * 0.2;
            const totalLiquido = totalBruto - totalComissao;

            rows.push([], ["Totais", "", formatCurrency(totalBruto), formatCurrency(totalComissao), formatCurrency(totalLiquido)]);

            // Adiciona título e intervalo de datas da semana
            const reportTitle = `Relatório Financeiro - Semana de ${startOfWeek.format("DD/MM/YYYY")} a ${endOfWeek.format("DD/MM/YYYY")}`;
            pdfDoc.setFontSize(18);
            pdfDoc.text(reportTitle, 14, 20);
            pdfDoc.setFontSize(12);
            pdfDoc.text(`Nome do Usuário: ${userName}`, 14, 30);
            pdfDoc.text(`Gerado em: ${now.format("DD/MM/YYYY HH:mm")}`, 14, 36);

            // Tabela
            pdfDoc.autoTable({
                head: [headers],
                body: rows,
                startY: 50,
                styles: {
                    halign: 'right',
                    fontSize: 10,
                },
                columnStyles: {
                    0: { halign: 'left' }, // Data alinhada à esquerda
                    1: { halign: 'left' }  // Descrição alinhada à esquerda
                }
            });

            // Adiciona um rodapé
            const pageCount = pdfDoc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdfDoc.setPage(i);
                pdfDoc.setFontSize(10);
                pdfDoc.text(`Página ${i} de ${pageCount}`, pdfDoc.internal.pageSize.width / 2, pdfDoc.internal.pageSize.height - 10, { align: 'center' });
            }

            // Baixa o PDF com o nome da semana no arquivo
            pdfDoc.save(`relatorio_financeiro_${startOfWeek.format("YYYYMMDD")}_a_${endOfWeek.format("YYYYMMDD")}.pdf`);
        }

        function formatCurrency(value) {
            return `R$ ${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        //Função para buscar pedidos do usuario para o relatorio financeiro
        async function fetchOrdersForUser(userId) {
            const ordersRef = collection(db, "orders");
            const q = query(ordersRef, where("userId", "==", userId), orderBy("completedAt", "desc"));
            const querySnapshot = await getDocs(q);

            const orders = [];
            querySnapshot.forEach((doc) => {
                orders.push({ ...doc.data(), id: doc.id });
            });

            return orders;
        }

        function showDetalhesAnuncio(data) {
            const modal = document.getElementById("modalDetalhes");
            const detalhesAnuncio = document.getElementById("detalhesAnuncio");

            // Limpa o conteúdo anterior
            detalhesAnuncio.innerHTML = "";

            // Estiliza e exibe o modal
            styleModal(modal);
            modal.style.display = "block";

            // Cria e adiciona o botão de fechar
            const closeBtn = createCloseButton(modal);
            modal.appendChild(closeBtn);

            // Adiciona conteúdo ao modal
            detalhesAnuncio.appendChild(createTitle(data.mensagem));
            if (data.imagemUrl) detalhesAnuncio.appendChild(createImage(data.imagemUrl));
            if (data.imagensAdicionaisUrls) detalhesAnuncio.appendChild(createImageCarousel(data.imagensAdicionaisUrls));
            detalhesAnuncio.appendChild(createDescriptionAndPrice(data.descricao, data.preco));
            detalhesAnuncio.appendChild(createServiceDetails(data.tipoServico, data.duracao));

            // Adiciona o botão de chat
            const chatButton = document.createElement("button");
            chatButton.innerHTML = '<i class="fas fa-comment-dots"></i> iniciar Conversa';
            chatButton.style.backgroundColor = "#e67e22";
            chatButton.style.border = "none";
            chatButton.style.color = "#fff";
            chatButton.style.padding = "10px 16px";
            chatButton.style.borderRadius = "6px";
            chatButton.style.cursor = "pointer";
            chatButton.style.fontSize = "16px";
            chatButton.style.marginTop = "20px";
            chatButton.style.boxShadow = "0 4px 8px rgba(0,0,0,0.2)";
            chatButton.style.transition = "all 0.3s ease";
            chatButton.style.width = "100%";

            chatButton.onclick = () => {
                iniciarCompra(data.userId, auth.currentUser.uid, data);
                chatButton.style.transform = "scale(0.95)";
                setTimeout(() => chatButton.style.transform = "scale(1)", 100);
            };

            detalhesAnuncio.appendChild(chatButton);
        }

        // Funções auxiliares atualizadas para serviços
        function createServiceDetails(servico, duracao) {

            // Normaliza o valor para garantir que está correto
            servico = servico ? servico.trim().toLowerCase() : 'outros';

            const container = document.createElement("div");
            container.style.marginBottom = "25px";
            container.style.padding = "15px";
            container.style.border = "1px solid #f0f0f0";
            container.style.borderRadius = "10px";
            container.style.boxShadow = "0px 4px 8px rgba(0, 0, 0, 0.1)";
            container.style.backgroundColor = "#fff";
            container.style.display = "flex";
            container.style.alignItems = "center";

            // Ícone do serviço
            const iconContainer = document.createElement("div");
            iconContainer.style.marginRight = "15px";
            const icon = document.createElement("i");
            icon.style.fontSize = "32px";
            icon.style.color = "#ff69b4";

            // Verificar e definir o ícone conforme o serviço
            switch (servico) {
                case "manicure":
                    icon.className = "fa fa-hand-sparkles"; // Icone manicure
                    break;
                case "pedicure":
                    icon.className = "fa fa-footprint"; // Icone pedicure
                    break;
                case "manicurepedicure":
                    icon.className = "fa fa-spa"; // Icone manicure e pedicure
                    break;
                case "designersobrancelhas":
                    icon.className = "fa fa-eye"; // Icone sobrancelhas
                    break;
                case "maquiagem":
                    icon.className = "fa fa-paint-brush"; // Icone maquiagem
                    break;
                case "massagem":
                    icon.className = "fa fa-hand-holding-heart"; // Icone massagem
                    break;
                case "depilacao":
                    icon.className = "fa fa-water"; // Icone depilação
                    break;
                case "alongamentocilios":
                    icon.className = "fa fa-eye-slash"; // Icone cílios
                    break;
                case "tratamentocapilar":
                    icon.className = "fa fa-cut"; // Icone tratamento capilar
                    break;
                case "outros":
                    icon.className = "fa fa-star"; // Icone outros
                    break;
                default:
                    icon.className = "fa fa-circle"; // Icone padrão
            }

            iconContainer.appendChild(icon);
            container.appendChild(iconContainer);

            // Informações do serviço
            const infoContainer = document.createElement("div");

            const servicoElem = document.createElement("p");
            servicoElem.innerHTML = `<strong>Serviço:</strong> ${servico}`;
            Object.assign(servicoElem.style, {
                color: "#333",
                fontSize: "16px",
                fontWeight: "500",
                marginBottom: "5px",
            });

            const duracaoElem = document.createElement("p");
            duracaoElem.innerHTML = `<strong>Duração:</strong> ${duracao} horas`;
            Object.assign(duracaoElem.style, {
                color: "#555",
                fontSize: "14px",
            });

            infoContainer.appendChild(servicoElem);
            infoContainer.appendChild(duracaoElem);
            container.appendChild(infoContainer);

            return container;
        }

        // Funções auxiliares gerais
        function styleModal(modal) {
            Object.assign(modal.style, {
                position: "fixed",
                top: "50%",
                left: "50%",
                transform: "translate(-50%, -50%)",
                width: "90%",
                maxWidth: "600px",
                height: "80%",
                backgroundColor: "#ffffff",
                borderRadius: "15px",
                boxShadow: "0 4px 25px rgba(0, 0, 0, 0.4)",
                padding: "20px",
                overflowY: "auto",
                animation: "fadeIn 0.5s ease",
                zIndex: "1000",
            });
        }

        function createCloseButton(modal) {
            const closeBtn = document.createElement("button");
            closeBtn.innerHTML = "&times;";
            Object.assign(closeBtn.style, {
                position: "absolute",
                top: "15px",
                right: "15px",
                fontSize: "28px",
                color: "#ff4757",
                border: "none",
                background: "none",
                cursor: "pointer",
            });
            closeBtn.onclick = function () {
                modal.style.animation = "fadeOut 0.5s ease";
                setTimeout(() => (modal.style.display = "none"), 500);
            };
            return closeBtn;
        }

        function createTitle(text) {
            const titulo = document.createElement("h2");
            titulo.textContent = text;
            Object.assign(titulo.style, {
                fontSize: "24px",
                color: "#ff4757",
                marginBottom: "15px",
                fontWeight: "bold",
                textAlign: "center",
                animation: "slideDown 0.5s ease",
            });
            return titulo;
        }

        function createImage(url) {
            const img = document.createElement("img");
            img.src = url;
            Object.assign(img.style, {
                width: "100%",
                borderRadius: "10px",
                marginBottom: "20px",
            });
            return img;
        }

        function createImageCarousel(urls) {
            const container = document.createElement("div");
            Object.assign(container.style, {
                display: "flex",
                justifyContent: "center",
                gap: "10px",
                marginBottom: "20px",
            });

            urls.forEach((url, index) => {
                const img = document.createElement("img");
                img.src = url;
                Object.assign(img.style, {
                    width: "80px",
                    height: "80px",
                    borderRadius: "8px",
                    cursor: "pointer",
                    transition: "transform 0.3s ease",
                });
                img.onclick = function () {
                    openFullscreen(url, urls, index);
                };
                img.onmouseover = () => (img.style.transform = "scale(1.1)");
                img.onmouseout = () => (img.style.transform = "scale(1)");
                container.appendChild(img);
            });

            return container;
        }

        function createDescriptionAndPrice(descricao, preco) {
            const container = document.createElement("div");
            container.style.marginBottom = "20px";

            const descricaoElem = document.createElement("p");
            descricaoElem.innerHTML = `<strong>Descrição:</strong> ${descricao}`;
            Object.assign(descricaoElem.style, {
                color: "#2f3542",
                fontSize: "16px",
                lineHeight: "1.6",
            });

            const precoElem = document.createElement("p");
            precoElem.innerHTML = `<strong>Preço:</strong> ${parseFloat(preco).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
            Object.assign(precoElem.style, {
                color: "#ff6b81",
                fontSize: "20px",
                fontWeight: "bold",
            });

            container.appendChild(descricaoElem);
            container.appendChild(precoElem);
            return container;
        }

        // Estilos CSS inline para animações e scroll
        document.head.innerHTML += `
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }

            @keyframes slideDown {
                from { transform: translateY(-20px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }

            #modalDetalhes {
                overflow-y: auto; /* Permite scroll vertical */
            }
        </style>`;

        function openFullscreen(currentImageUrl, imageUrls, currentIndex) {
            const fullscreenContainer = document.createElement("div");
            fullscreenContainer.className = "imagem-fullscreen";
            fullscreenContainer.style.display = "flex";

            const img = document.createElement("img");
            img.src = currentImageUrl;
            fullscreenContainer.appendChild(img);

            document.body.appendChild(fullscreenContainer);

            fullscreenContainer.onclick = function () {
                fullscreenContainer.remove();
            };

            // Botões de navegação
            const prevBtn = document.createElement("button");
            prevBtn.className = "nav-btn left";
            prevBtn.innerHTML = "&#10094;"; // Unicode para seta à esquerda
            fullscreenContainer.appendChild(prevBtn);

            const nextBtn = document.createElement("button");
            nextBtn.className = "nav-btn right";
            nextBtn.innerHTML = "&#10095;"; // Unicode para seta à direita
            fullscreenContainer.appendChild(nextBtn);

            // Navegação entre imagens
            prevBtn.onclick = function (e) {
                e.stopPropagation();
                currentIndex = (currentIndex - 1 + imageUrls.length) % imageUrls.length;
                img.src = imageUrls[currentIndex];
            };

            nextBtn.onclick = function (e) {
                e.stopPropagation();
                currentIndex = (currentIndex + 1) % imageUrls.length;
                img.src = imageUrls[currentIndex];
            };
        }

        window.onclick = function (event) {
            const modal = document.getElementById("modalDetalhes");
            if (event.target === modal) {
                modal.style.display = "none";
            }
        };

        // Fechar o modal quando o usuário clicar no botão de fechar
        document.getElementById("closeModal").onclick = function () {
            document.getElementById("modalDetalhes").style.display = "none";
        };

        // Fechar o modal quando o usuário clicar fora do modal
        window.onclick = function (event) {
            const modal = document.getElementById("modalDetalhes");
            if (event.target === modal) {
                modal.style.display = "none";
            }
        };

        // Fechar a visualização em tela cheia ao clicar fora da imagem
        document.getElementById("imagemFullscreen").onclick = function () {
            this.style.display = "none";
        }

        let currentChatId = null;

        // Função para iniciar a compra e criar um novo chat
        async function iniciarCompra(vendedorId, compradorId, produto) {
            try {
                // Criar o documento do chat
                const chatRef = await addDoc(collection(db, "chats"), {
                    vendedorId: vendedorId,
                    compradorId: compradorId,
                    produto: produto,
                    timestamp: serverTimestamp(),
                    mensagens: [] // Iniciar com array vazio
                });
                console.log("Chat criado com sucesso:", chatRef.id);

                // Adicionar a mensagem inicial separadamente
                const timestamp = new Date();
                await updateDoc(chatRef, {
                    mensagens: arrayUnion({
                        sender: "vendedor",
                        texto: `Olá.`,
                        timestamp: timestamp,
                    })
                });

                // Abrir o chat após a criação e adição da mensagem inicial
                openChat(chatRef.id, produto.descricao);

                // Trocar para a aba de notificações
                showTab('notificacoes');
            } catch (error) {
                console.error("Erro ao iniciar a compra:", error);
            }
        }

        // Função para carregar chats do usuário
        async function loadChats(userId) {
            try {
                const vendedorQuery = query(collection(db, "chats"), where("vendedorId", "==", userId));
                const compradorQuery = query(collection(db, "chats"), where("compradorId", "==", userId));

                const [vendedorSnapshot, compradorSnapshot] = await Promise.all([
                    getDocs(vendedorQuery),
                    getDocs(compradorQuery)
                ]);

                const allChats = [];
                vendedorSnapshot.forEach(doc => allChats.push({ id: doc.id, data: doc.data() }));
                compradorSnapshot.forEach(doc => allChats.push({ id: doc.id, data: doc.data() }));

                const getLastMessageTimestamp = async (chatId) => {
                    const chatRef = doc(db, "chats", chatId);
                    const chatDoc = await getDoc(chatRef);
                    const chatData = chatDoc.data();

                    if (chatData.mensagens && chatData.mensagens.length > 0) {
                        const lastMessage = chatData.mensagens[chatData.mensagens.length - 1];
                        return lastMessage.timestamp.toDate();
                    }
                    return new Date(0);
                };

                const chatsWithTimestamps = await Promise.all(allChats.map(async (chat) => {
                    const lastMessageTimestamp = await getLastMessageTimestamp(chat.id);
                    return { ...chat, lastMessageTimestamp };
                }));

                chatsWithTimestamps.sort((a, b) => b.lastMessageTimestamp - a.lastMessageTimestamp);

                const chatListContainer = document.getElementById("chatList");
                chatListContainer.innerHTML = "";

                const getUserData = async (userId) => {
                    const userDoc = await getDoc(doc(db, "users", userId));
                    return userDoc.exists() ? userDoc.data() : null;
                };

                const createChatElement = async (chatData, chatId, lastMessageTimestamp) => {
                    const compradorData = await getUserData(chatData.compradorId);
                    const vendedorData = await getUserData(chatData.vendedorId);

                    const chatElement = document.createElement("div");
                    chatElement.style.display = "flex";
                    chatElement.style.alignItems = "center";
                    chatElement.style.marginBottom = "10px";
                    chatElement.style.padding = "10px";
                    chatElement.style.border = "1px solid #ddd";
                    chatElement.style.borderRadius = "8px";
                    chatElement.style.backgroundColor = "#fff";
                    chatElement.style.boxShadow = "0 2px 4px rgba(0, 0, 0, 0.1)";
                    chatElement.style.cursor = "pointer";

                    const produto = chatData.produto || {};
                    const imagemUrlProduto = produto.imagemUrl || "https://firebasestorage.googleapis.com/v0/b/redesocialmarktplace.appspot.com/o/default.png?alt=media&token=7dffcc8c-de86-4855-8f04-1fbb99bc8e39";
                    const descricaoProduto = produto.descricao || "Produto não especificado";
                    const nomeComprador = compradorData?.fullName || "Comprador";
                    const nomeVendedor = vendedorData?.fullName || "Vendedor";
                    const fotoComprador = compradorData?.photoURL || "https://via.placeholder.com/50";
                    const fotoVendedor = vendedorData?.photoURL || "https://via.placeholder.com/50";

                    const formattedTimestamp = lastMessageTimestamp.toLocaleDateString("pt-BR", {
                        day: "2-digit",
                        month: "short",
                        hour: "2-digit",
                        minute: "2-digit"
                    });

                    chatElement.innerHTML = `
                    <img src="${imagemUrlProduto}" alt="${descricaoProduto}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; margin-right: 10px;">
                    <div style="flex: 1;">
                        <div style="font-size: 1em; font-weight: bold;">${descricaoProduto}</div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <div style="text-align: center;">
                                    <img src="${fotoComprador}" alt="${nomeComprador}" style="width: 30px; height: 30px; border-radius: 50%; margin-bottom: 2px;">
                                    <div style="font-size: 0.8em; color: #555;">${nomeComprador}</div>
                                </div>
                                <div style="font-size: 0.8em; color: #777; text-align: center;">${formattedTimestamp}</div>
                                <div style="text-align: center;">
                                    <img src="${fotoVendedor}" alt="${nomeVendedor}" 
                                    style="width: 30px; height: 30px; border-radius: 50%; margin-bottom: 2px;">
                                <div style="font-size: 0.8em; color: #555;">${nomeVendedor}</div>
                            </div>
                        </div>
                    </div>`;

                    chatElement.addEventListener("click", () => {
                        openChatFromButton({ dataset: { chatId } });
                    });

                    return chatElement;
                };

                for (const chat of chatsWithTimestamps) {
                    const chatElement = await createChatElement(chat.data, chat.id, chat.lastMessageTimestamp);
                    chatListContainer.appendChild(chatElement);
                }
            } catch (error) {
                console.error("Erro ao carregar chats:", error);
            }
        }

        window.openChatFromButton = function (button) {
            const chatId = button.dataset.chatId;
            const produtoDescricao = button.dataset.produtoDescricao;
            openChat(chatId, produtoDescricao);
        }

        // Função para abrir o chat
        let isFirstLoad = true; // Variável para controlar o primeiro carregamento do chat

        function openChat(chatId, produtoDescricao) {
            currentChatId = chatId; // Define o ID do chat atual
            const chatModal = document.getElementById("chatModal");
            chatModal.style.display = "block";

            loadChatMessages(chatId); // Carrega as mensagens do chat

            // Espera a renderização das mensagens para armazenar a posição inicial de rolagem
            const chatContainer = document.getElementById("chatContainer");
            const initialScrollPosition = chatContainer.scrollTop;

            // Verifica se o chatId atual corresponde ao chat sendo visualizado
            const chatRef = doc(db, "chats", chatId);
            onSnapshot(chatRef, (doc) => {
                if (doc.exists()) {
                    // Apenas atualiza as mensagens se o chat aberto for o mesmo que o chatId atual
                    if (currentChatId === chatId) {
                        loadChatMessages(chatId); // Atualiza as mensagens em tempo real

                        // Só rola para a última mensagem na primeira vez que o chat é aberto
                        if (isFirstLoad) {
                            setTimeout(() => {
                                chatContainer.scrollTop = chatContainer.scrollHeight; // Rola para o fim
                            }, 100); // Aguarda um tempo para garantir que as mensagens tenham sido carregadas
                            isFirstLoad = false; // Desativa o rolar automático após o primeiro carregamento
                        } else {
                            chatContainer.scrollTop = initialScrollPosition; // Mantém a posição de rolagem
                        }
                    }
                }
            });
        }

        // Função para fechar o chat
        window.closeChat = function () {
            document.getElementById("chatModal").style.display = "none";
            currentChatId = null;
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp * 1000);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}`;
        }

        // Substitua toLocaleString por formatTimestamp no código de exibição de mensagens
        async function loadChatMessages(chatId) {
            try {
                const chatDoc = await getDoc(doc(db, "chats", chatId));
                if (chatDoc.exists()) {
                    const chatData = chatDoc.data();
                    const chatMessagesContainer = document.getElementById("chatMessages");

                    const compradorData = await getUserData(chatData.compradorId);
                    const vendedorData = await getUserData(chatData.vendedorId);

                    const chatTitle = document.getElementById("chatTitle");
                    chatTitle.innerHTML = `
                <div class="chat-title-content">
                    <img src="${vendedorData.photoURL || 'default-photo-url.png'}" alt="${vendedorData.fullName}" class="user-avatar">
                        <span class="negotiation-icon">
                            <i class="fas fa-paper-plane"></i>
                        </span>
                    <img src="${compradorData.photoURL || 'default-photo-url.png'}" alt="${compradorData.fullName}" class="user-avatar">
                </div>
                <div class="chat-title-names">
                    <div>${vendedorData.fullName}</div>
                    <div style="margin-left: 3%;"></div>
                    <div>${compradorData.fullName}</div>
                </div>`;

                    chatMessagesContainer.innerHTML = "";

                    chatData.mensagens.forEach((mensagem) => {
                        const messageElement = document.createElement("div");
                        messageElement.classList.add("message-container");

                        let senderData = null;
                        if (mensagem.sender === "vendedor") {
                            senderData = vendedorData;
                            messageElement.classList.add("me");
                        } else if (mensagem.sender === "cliente") {
                            senderData = compradorData;
                        }

                        if (senderData) {
                            const senderName = senderData.fullName || "Usuário";
                            const senderPhoto = senderData.photoURL || "default-photo-url.png";

                            messageElement.innerHTML = `
                        <img src="${senderPhoto}" alt="${senderName}" class="message-avatar">
                        <div class="message-content">
                            <div class="message-sender">${sanitizeHTML(senderName)}</div>
                            <div class="message-text">${sanitizeHTML(mensagem.texto)}</div>
                            <div class="message-time">${formatTimestamp(mensagem.timestamp.seconds)}</div>
                        </div>`;
                        } else {
                            messageElement.innerHTML = `
                        <div class="message-content">
                            <strong>Desconhecido:</strong> ${sanitizeHTML(mensagem.texto)} 
                            <small>(${formatTimestamp(mensagem.timestamp.seconds)})</small>
                        </div>`;
                        }

                        chatMessagesContainer.appendChild(messageElement);
                    });

                    chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
                } else {
                    console.log("Nenhum chat encontrado com esse ID:", chatId);
                }
            } catch (error) {
                console.error("Erro ao carregar o chat:", error);
            }
        }

        window.sendMessage = async function () {
            const chatInput = document.getElementById("chatInput");
            let messageText = chatInput.value.trim();

            if (messageText === "" || currentChatId === null) return;

            // Sanitizar o texto da mensagem
            messageText = sanitizeHTML(messageText);

            try {
                const user = auth.currentUser;

                if (!user) {
                    console.error("Usuário não autenticado.");
                    return;
                }

                const userId = user.uid;
                const chatRef = doc(db, "chats", currentChatId);
                const chatDoc = await getDoc(chatRef);

                if (chatDoc.exists()) {
                    const chatData = chatDoc.data();
                    const timestamp = new Date();
                    let senderType = "";

                    if (userId === chatData.vendedorId) {
                        senderType = "vendedor";
                    } else if (userId === chatData.compradorId) {
                        senderType = "cliente";
                    } else {
                        console.error("Erro: ID do usuário não corresponde ao vendedor nem ao comprador.");
                        return;
                    }

                    await updateDoc(chatRef, {
                        mensagens: arrayUnion({
                            sender: senderType,
                            texto: messageText, // Texto sanitizado
                            timestamp: timestamp,
                        })
                    });

                    chatInput.value = "";
                }
            } catch (error) {
                console.error("Erro ao enviar mensagem:", error);
            }
        };

        let unreadMessagesCount = 0;

        // Função para atualizar o contador de notificações
        function updateNotificationCounter(count) {
            const counterElement = document.getElementById("notificationCounter");
            counterElement.textContent = count > 0 ? count : '';
            counterElement.style.display = count > 0 ? 'flex' : 'none';

            // Salvar o contador no localStorage
            localStorage.setItem('unreadMessagesCount', count.toString());
        }

        // Função para restaurar o contador após atualizar a página
        function restoreNotificationCounter() {
            const savedCount = localStorage.getItem('unreadMessagesCount');
            if (savedCount !== null) {
                unreadMessagesCount = parseInt(savedCount, 10);
                updateNotificationCounter(unreadMessagesCount);
            }
        }

        // Função para monitorar alterações nos chats
        async function monitorChats(userId) {
            const chatsRef = collection(db, "chats");

            // Consultas para obter chats onde o usuário é comprador ou vendedor
            const compradorQuery = query(chatsRef, where("compradorId", "==", userId));
            const vendedorQuery = query(chatsRef, where("vendedorId", "==", userId));

            // Função para lidar com alterações nas mensagens
            function handleSnapshot(snapshot) {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "modified") {
                        const chatData = change.doc.data();
                        const isVendedor = chatData.vendedorId === userId;
                        const messages = chatData.mensagens || [];
                        const lastMessage = messages[messages.length - 1];

                        if (lastMessage &&
                            ((isVendedor && lastMessage.sender !== "vendedor") ||
                                (!isVendedor && lastMessage.sender !== "comprador"))) {
                            unreadMessagesCount += 1;
                        }
                    }
                });

                updateNotificationCounter(unreadMessagesCount);
            }

            // Monitorar as consultas
            onSnapshot(compradorQuery, handleSnapshot);
            onSnapshot(vendedorQuery, handleSnapshot);
        }

        // Função para zerar o contador quando as notificações são abertas
        function resetNotificationCounter() {
            unreadMessagesCount = 0;
            updateNotificationCounter(0);
        }

        // Restaurar o contador ao carregar a página
        document.addEventListener("DOMContentLoaded", restoreNotificationCounter);

        document.addEventListener('DOMContentLoaded', function () {
            showTab('timeline');
        });

        document.getElementById('btnEscolherArquivo').addEventListener('click', function () {
            document.getElementById('inputImagem').click();
        });

        // Função para lidar com o upload da foto de perfil
        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (file) {
                compressAndUploadProfilePicture(file);
            }
        }

        function sanitizeHTML(str) {
            const temp = document.createElement("div");
            temp.textContent = str;
            return temp.innerHTML;
        }

        // Função para comprimir e enviar a foto de perfil para o armazenamento
        window.compressAndUploadProfilePicture = async function (file) {
            try {
                const compressedBlob = await compressImage(file);
                const storageRef = ref(storage, `perfil/${auth.currentUser.uid}`);
                const snapshot = await uploadBytes(storageRef, compressedBlob);
                const downloadURL = await getDownloadURL(snapshot.ref);

                // Atualize a foto de perfil do usuário no banco de dados Firebase
                await updateDoc(doc(db, "users", auth.currentUser.uid), {
                    photoURL: downloadURL
                });

                // Atualize a foto de perfil na interface do usuário
                document.getElementById("userProfilePicture").src = downloadURL;
            } catch (error) {
                console.error("Erro ao fazer upload da foto de perfil:", error);
            }
        }

        document.getElementById('btnEscolherFotoPerfil').addEventListener('click', function () {
            document.getElementById('inputFotoPerfil').click();
        })

        window.handleProfilePictureUpload = function (event) {
            const file = event.target.files[0];
            if (file) {
                compressAndUploadProfilePicture(file);
            }
        }

        // Função para exibir o perfil do usuário
        async function exibirPerfilUsuario(uid) {
            try {
                // Obter os dados do usuário do Firestore
                const userDoc = await getDoc(doc(db, "users", uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();

                    // Atualizar o nome do usuário
                    const userProfileName = document.getElementById("userProfileName");
                    userProfileName.textContent = userData.fullName || "Nome do usuário não disponível";

                    // Exibir o setor do usuário
                    const userSector = document.getElementById("userSector");
                    if (userSector) {
                        userSector.textContent = userData.setor || "Setor não disponível";
                    }

                    // Exibir a data de entrada do usuário
                    const userEntryDate = document.getElementById("userEntryDate");
                    if (userEntryDate) {
                        userEntryDate.textContent = `Entrou em: ${userData.entrou || "Data não disponível"}`; // Substitua `entrou` pelo campo correto
                    }

                    // Exibir a mensagem de verificação
                    const userVerification = document.getElementById("userVerification");
                    if (userVerification) {
                        userVerification.textContent = "Profissional verificado e treinado pela equipe";
                    }

                    // Verificar se o usuário possui uma foto de perfil
                    if (userData.photoURL) {
                        // Se tiver, atualizar a foto de perfil do usuário
                        const userProfilePicture = document.getElementById("userProfilePicture");
                        const userProfilePicturePopUp = document.getElementById("userProfilePicturePopUp");
                        userProfilePicturePopUp.src = userData.photoURL;
                        userProfilePicture.src = userData.photoURL;
                    } else {
                        // Se não tiver, usar uma foto de perfil padrão
                        const userProfilePicture = document.getElementById("userProfilePicture");
                        const userProfilePicturePopUp = document.getElementById("userProfilePicturePopUp");
                        userProfilePicture.src = "perfil/fotoPadrao.png";
                        userProfilePicturePopUp.src = "perfil/fotoPadrao.png";
                    }

                    // Exibir os anúncios do usuário
                    await carregarAnunciosDoUsuario(uid);

                } else {
                    console.log("Usuário não encontrado no Firestore");
                }
            } catch (error) {
                console.error("Erro ao exibir perfil do usuário:", error);
            }
        }

        // Função para verificar se o usuário já curtiu uma publicação
        function hasLikedPost(postId) {
            return localStorage.getItem(`like_${postId}`) === 'true';
        }

        // Função para verificar se o usuário já descurtiu uma publicação
        function hasDislikedPost(postId) {
            return localStorage.getItem(`dislike_${postId}`) === 'true';
        }

        // Função para incrementar um valor em um campo específico
        window.increment = function (value) {
            return value + 1;
        }

        // Função para curtir uma publicação
        window.likePost = async function (postId) {
            try {
                // Verificar se o usuário já curtiu a publicação
                if (hasLikedPost(postId)) {
                    return;
                }

                // Verificar se o usuário já descurtiu a publicação e remover o deslike
                if (hasDislikedPost(postId)) {
                    await removeDislike(postId);
                }

                const postRef = doc(db, "publicacoes", postId);
                await incrementCounter(postRef, 'likes');

                // Atualizar o contador de likes na página
                const likeCountElement = document.getElementById(`likeCount_${postId}`);
                if (likeCountElement) {
                    likeCountElement.textContent = parseInt(likeCountElement.textContent) + 1;
                } else {
                    console.error(`Elemento de contagem de likes com ID likeCount_${postId} não encontrado.`);
                }

                // Desabilitar o botão de like após um clique
                const likeButton = document.getElementById(`likeButton_${postId}`);
                if (likeButton) {
                    likeButton.disabled = true;
                } else {
                    console.error(`Botão de like com ID likeButton_${postId} não encontrado.`);
                }

                // Armazenar o estado de curtida no armazenamento local
                localStorage.setItem(`like_${postId}`, 'true');
            } catch (error) {
                console.error("Erro ao curtir a publicação:", error);
            }
        }

        window.incrementCounter = async function (docRef, field) {
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const currentData = docSnap.data();
                    const newValue = currentData[field] ? currentData[field] + 1 : 1; // Incrementar o valor atual ou começar de 1 se não existir
                    await updateDoc(docRef, {
                        [field]: newValue
                    });
                } else {
                    // Se o documento não existir, criar um novo com o campo inicializado com 1
                    await setDoc(docRef, { [field]: 1 });
                }
            } catch (error) {
                console.error("Erro ao incrementar o contador:", error);
            }
        }

        window.addComment = async function (postId) {
            try {
                const commentText = document.getElementById(`commentText_${postId}`).value;

                // Verificar se o texto do comentário está vazio
                if (!commentText) {
                    alert("Por favor, digite seu comentário.");
                    return;
                }

                // Adicionar um novo documento a coleção
                const comentarioRef = await addDoc(collection(db, `publicacoes/${postId}/comentarios`), {
                    texto: commentText,
                    userId: auth.currentUser.uid,
                    timestamp: serverTimestamp()
                });

                // Limpar o campo do texto do comentário após adicionar o comentário
                document.getElementById(`commentText_${postId}`).value = "";

                // Exibir os comentários atualizados
                showComments(postId);
            } catch (error) {
                console.error("Erro ao adicionar comentário:", error);
            }
        }

        let commentsVisible = false;

        // Função para exibir ou ocultar os comentários de uma publicação
        window.showComments = async function (postId) {
            try {
                const commentsDiv = document.getElementById(`comments_${postId}`);
                const isVisible = commentsDiv.style.display === "block";

                if (isVisible) {
                    commentsDiv.style.display = "none";
                } else {
                    commentsDiv.innerHTML = "";

                    const comentariosRef = collection(db, `publicacoes/${postId}/comentarios`);
                    const querySnapshot = await getDocs(comentariosRef);

                    if (querySnapshot.empty) {
                        return;
                    }

                    querySnapshot.forEach(async (doc) => {
                        const comentario = doc.data();
                        const user = await getUserData(comentario.userId);

                        // Criação do elemento li para cada comentário
                        const li = document.createElement("li");
                        li.classList.add("timeline-item");
                        li.style.backgroundColor = "#f0f0f0";
                        li.style.padding = "10px";
                        li.style.borderRadius = "4px";
                        li.style.marginBottom = "15%";
                        li.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.1)";
                        li.style.transition = "all 0.3s ease";
                        li.style.transform = "translateY(0)";

                        function applyHoverStyles() {
                            li.style.boxShadow = "0 20px 40px rgba(0, 0, 0, 0.5)";
                            li.style.transform = "translateY(-10px)";
                        }

                        function removeHoverStyles() {
                            li.style.boxShadow = "0 10px 20px rgba(0, 0, 0, 0.3)";
                            li.style.transform = "translateY(0)";
                        }

                        li.addEventListener("mouseover", applyHoverStyles);
                        li.addEventListener("mouseout", removeHoverStyles);
                        li.addEventListener("touchstart", applyHoverStyles, { passive: true });
                        li.addEventListener("touchend", removeHoverStyles, { passive: true });

                        const userInfoContainer = document.createElement("div");
                        userInfoContainer.style.display = "flex";
                        userInfoContainer.style.alignItems = "center";
                        userInfoContainer.style.marginBottom = "10px";

                        const userImg = document.createElement("img");
                        userImg.src = user.photoURL;
                        userImg.alt = "Foto do usuário";
                        userImg.style.width = "60px";
                        userImg.style.height = "60px";
                        userImg.style.borderRadius = "50%";
                        userImg.style.marginRight = "15px";
                        userImg.style.cursor = "pointer";
                        userImg.style.border = "2px solid #ddd";
                        userInfoContainer.appendChild(userImg);

                        const userName = document.createElement("p");
                        userName.textContent = DOMPurify.sanitize(user.fullName); // Sanitiza a saída
                        userName.style.fontWeight = "bold";
                        userName.style.cursor = "pointer";
                        userInfoContainer.appendChild(userName);

                        li.appendChild(userInfoContainer);

                        const commentText = document.createElement("p");
                        commentText.textContent = DOMPurify.sanitize(comentario.texto); // Sanitiza a saída
                        commentText.style.marginBottom = "10px";
                        commentText.style.fontSize = "16px";
                        li.appendChild(commentText);

                        const timestamp = comentario.timestamp.toDate();
                        const dia = String(timestamp.getDate()).padStart(2, '0');
                        const mes = String(timestamp.getMonth() + 1).padStart(2, '0');
                        const ano = timestamp.getFullYear();
                        const horas = String(timestamp.getHours()).padStart(2, '0');
                        const minutos = String(timestamp.getMinutes()).padStart(2, '0');
                        const dataFormatada = `${dia}/${mes}/${ano} ${horas}:${minutos}`;

                        const commentTime = document.createElement("p");
                        commentTime.textContent = `Data e Hora: ${dataFormatada}`;
                        commentTime.style.fontSize = "12px";
                        commentTime.style.color = "#999";
                        li.appendChild(commentTime);

                        commentsDiv.appendChild(li);
                    });

                    commentsDiv.style.display = "block";
                }
            } catch (error) {
                console.error("Erro ao exibir ou ocultar comentários:", error);
            }
        };

        // Função para obter informações do usuário com base no userId
        async function getUserData(userId) {
            const userDoc = await getDoc(doc(db, "users", userId));
            if (userDoc.exists()) {
                return userDoc.data();
            } else {
                return null;
            }
        }

        // Função para excluir uma publicação
        window.deletePost = async function (postId, userId) {
            try {
                // Confirmar se o usuário deseja realmente excluir a publicação
                const confirmDelete = confirm("Tem certeza de que deseja excluir esta publicação?");
                if (!confirmDelete) {
                    return;
                }

                // Verificar se o usuário atual é o dono da publicação
                if (userId !== auth.currentUser.uid) {
                    console.log("Você não tem permissão para excluir esta publicação.");
                    return;
                }

                // Excluir todos os comentários associados à publicação
                const comentariosRef = collection(db, `publicacoes/${postId}/comentarios`);
                const comentariosSnapshot = await getDocs(comentariosRef);
                comentariosSnapshot.forEach(async (doc) => {
                    await deleteDoc(doc.ref);
                });

                // Obter os dados da publicação para acessar as URLs das imagens
                const postDoc = await getDoc(doc(db, "publicacoes", postId));
                if (postDoc.exists()) {
                    const postData = postDoc.data();

                    // Excluir a imagem principal associada à publicação no Storage
                    if (postData.imagemUrl) {
                        const imageRef = ref(storage, postData.imagemUrl);
                        await deleteObject(imageRef);
                        console.log("Imagem principal associada à publicação excluída com sucesso.");
                    }

                    // Excluir as imagens adicionais associadas à publicação no Storage
                    if (postData.imagensAdicionaisUrls && postData.imagensAdicionaisUrls.length > 0) {
                        for (const url of postData.imagensAdicionaisUrls) {
                            const imageRef = ref(storage, url);
                            await deleteObject(imageRef);
                            console.log("Imagem adicional associada à publicação excluída com sucesso.");
                        }
                    }
                }

                // Finalmente, excluir o documento de publicação
                await deleteDoc(doc(db, "publicacoes", postId));

                console.log("Publicação excluída com sucesso.");
            } catch (error) {
                console.error("Erro ao excluir a publicação:", error);
            }

            location.reload();
        }

        // Função para atualizar os contadores de likes e deslikes
        window.updateLikeDislikeCounts = async function (postId) {
            const postRef = doc(db, "publicacoes", postId);
            const postSnap = await getDoc(postRef);
            if (postSnap.exists()) {
                const postData = postSnap.data();
                let likeCount = +1;
                let dislikeCount = +1;
                if (postData.likes) {
                    likeCount = postData.likes;
                }
                if (postData.dislikes) {
                    dislikeCount = postData.dislikes;
                }
                const likeCountElement = document.getElementById(`likeCount_${postId}`);
                const dislikeCountElement = document.getElementById(`dislikeCount_${postId}`);
                likeCountElement.textContent = likeCount;
                dislikeCountElement.textContent = dislikeCount;
            }
        }

        window.signOut = function () {
            try {
                // Fazer logout do usuário usando Firebase Authentication
                auth.signOut().then(() => {
                    // Redirecionar o usuário para a página de login após fazer logout
                    window.location.href = "login.html";
                }).catch((error) => {
                    console.error("Erro ao fazer logout:", error);
                });
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
            }
        }

        function makePreviewDraggable() {
            const previewContainer = document.getElementById('previewContainer');
            let offsetX = 0;
            let offsetY = 0;
            let isDragging = false;

            // Iniciar o movimento
            previewContainer.addEventListener('mousedown', startDrag);
            previewContainer.addEventListener('touchstart', startDrag, { passive: true });

            // Movimentar o preview
            previewContainer.addEventListener('mousemove', drag);
            previewContainer.addEventListener('touchmove', drag, { passive: false });

            // Finalizar o movimento
            previewContainer.addEventListener('mouseup', stopDrag);
            previewContainer.addEventListener('mouseleave', stopDrag);
            previewContainer.addEventListener('touchend', stopDrag);

            function startDrag(e) {
                isDragging = true;

                if (e.type === 'touchstart') {
                    offsetX = e.touches[0].clientX - previewContainer.getBoundingClientRect().left;
                    offsetY = e.touches[0].clientY - previewContainer.getBoundingClientRect().top;
                } else {
                    offsetX = e.clientX - previewContainer.getBoundingClientRect().left;
                    offsetY = e.clientY - previewContainer.getBoundingClientRect().top;
                }

                previewContainer.style.transition = 'none'; // Desativar transições durante o arraste
            }

            function drag(e) {
                if (!isDragging) return;

                e.preventDefault();

                let x, y;

                if (e.type === 'touchmove') {
                    x = e.touches[0].clientX;
                    y = e.touches[0].clientY;
                } else {
                    x = e.clientX;
                    y = e.clientY;
                }

                const newX = x - offsetX;
                const newY = y - offsetY;

                previewContainer.style.left = `${newX}px`;
                previewContainer.style.top = `${newY}px`;
                previewContainer.style.right = 'auto'; // Remover o posicionamento à direita
                previewContainer.style.bottom = 'auto'; // Remover o posicionamento abaixo
            }

            function stopDrag() {
                isDragging = false;
                previewContainer.style.transition = 'transform 0.3s ease'; // Restaurar transições após o arraste
            }
        }

        // Chamar a função para tornar o preview arrastável
        makePreviewDraggable();

        // Função para formatar o preço
        function formatarPreco(preco) {
            const precoNumero = parseFloat(preco.replace(/[^\d,]/g, '').replace(',', '.'));
            if (isNaN(precoNumero)) return 'Preço inválido';
            return precoNumero.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        // Adicionar eventos para atualizar o preview conforme o usuário preenche o formulário
        document.getElementById('inputMensagem').addEventListener('input', function () {
            const mensagem = this.value;
            document.getElementById('mensagemPreview').textContent = mensagem;
            mostrarPreview();
        });

        document.getElementById('inputDescricao').addEventListener('input', function () {
            const descricao = this.value;
            document.getElementById('descricaoPreview').textContent = descricao;
            mostrarPreview();
        });

        document.getElementById('inputPreco').addEventListener('input', function () {
            const preco = this.value;
            const precoFormatado = formatarPreco(preco);
            document.getElementById('precoPreview').textContent = `Preço: ${precoFormatado}`;
            mostrarPreview();
        });

        document.getElementById('inputImagem').addEventListener('change', function () {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('imgPreview').src = e.target.result;
                    mostrarPreview();
                }
                reader.readAsDataURL(this.files[0]);
            } else {
                document.getElementById('imgPreview').src = '';
            }
        });

        function mostrarPreview() {
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.classList.add('show');
        }

        function esconderPreview() {
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.classList.add('hidden');
        }

        // Função para denunciar uma publicação
        window.reportPost = async function (postId) {
            try {
                const docRef = doc(db, "publicacoes", postId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data && data.mensagem) {
                        const motivo = prompt("Por favor, informe o motivo da denúncia:");
                        if (motivo) {
                            const reportData = {
                                postId: postId,
                                motivo: motivo,
                                dataDenuncia: new Date().toISOString(),
                                conteudoPublicacao: {
                                    mensagem: data.mensagem,
                                    imagemUrl: data.imagemUrl || null
                                }
                            };
                            await addDoc(collection(db, "reportes"), reportData);
                            alert("Publicação denunciada com sucesso. Nossa equipe avaliará sua denúncia.");
                        } else {
                            alert("O motivo da denúncia é obrigatório.");
                        }
                    } else {
                        alert("A publicação não possui uma mensagem.");
                    }
                } else {
                    alert("A publicação não existe.");
                }
            } catch (error) {
                console.error("Erro ao denunciar a publicação:", error);
                alert("Ocorreu um erro ao denunciar a publicação. Por favor, tente novamente mais tarde.");
            }
        }

        // Função para exibir o perfil do usuário ao clicar no nome ou na foto de perfil
        function showUserProfile(userId) {
            console.log("Mostrando perfil do usuário com ID:", userId);

            // Obter o elemento do perfil do usuário
            const userProfileContainer = document.getElementById("userProfileContainer");

            // Limpar as informações anteriores do perfil do usuário
            document.getElementById("userProfileName").textContent = "";
            document.getElementById("userProfilePicturePopUp").src = "";

            // Exibir o perfil do usuário
            exibirPerfilUsuario(userId);

            // Mostrar a tela de perfil do usuário
            userProfileContainer.style.display = "flex";
        }

        // Função para fechar a tela do perfil do usuário
        window.closeUserProfile = function () {
            console.log("Fechando perfil do usuário.");

            // Ocultar a tela de perfil do usuário
            const userProfileContainer = document.getElementById("userProfileContainer");
            userProfileContainer.style.display = "none";
        }

        // Função para obter os anúncios do usuário
        async function carregarAnunciosDoUsuario(uid) {
            const userAdsList = document.getElementById("userAdsList");
            userAdsList.innerHTML = ""; // Limpar a lista antes de carregar

            try {
                const anunciosQuery = query(collection(db, "publicacoes"), where("userId", "==", uid));
                const anunciosSnapshot = await getDocs(anunciosQuery);

                anunciosSnapshot.forEach((docSnapshot) => {
                    const anuncio = docSnapshot.data();
                    const docId = docSnapshot.id;

                    // Criação do elemento li para cada anúncio
                    const li = document.createElement("li");
                    li.classList.add("ad-item");
                    li.style.backgroundColor = "#fff";
                    li.style.borderRadius = "8px";
                    li.style.boxShadow = "0 8px 16px rgba(0, 0, 0, 0.1)";
                    li.style.overflow = "hidden";
                    li.style.margin = "15px";
                    li.style.padding = "20px";
                    li.style.position = "relative";
                    li.style.transition = "transform 0.3s ease, box-shadow 0.3s ease";
                    li.style.cursor = "pointer";

                    // Estilo de hover
                    li.addEventListener("mouseover", () => {
                        li.style.transform = "translateY(-10px)";
                        li.style.boxShadow = "0 16px 32px rgba(0, 0, 0, 0.2)";
                    });
                    li.addEventListener("mouseout", () => {
                        li.style.transform = "translateY(0)";
                        li.style.boxShadow = "0 8px 16px rgba(0, 0, 0, 0.1)";
                    });

                    // Container para imagem
                    if (anuncio.imagemUrl) {
                        const imgContainer = document.createElement("div");
                        imgContainer.style.position = "relative";
                        imgContainer.style.overflow = "hidden";
                        imgContainer.style.borderRadius = "8px";
                        imgContainer.style.marginBottom = "15px";

                        const imagem = document.createElement("img");
                        imagem.src = anuncio.imagemUrl;
                        imagem.alt = "Imagem do anúncio";
                        imagem.style.width = "100%";
                        imagem.style.height = "auto";
                        imagem.style.transition = "transform 0.3s ease";
                        imgContainer.appendChild(imagem);

                        // Efeito de hover para imagem
                        imgContainer.addEventListener("mouseover", () => {
                            imagem.style.transform = "scale(1.05)";
                        });
                        imgContainer.addEventListener("mouseout", () => {
                            imagem.style.transform = "scale(1)";
                        });

                        li.appendChild(imgContainer);
                    }

                    // Adicionar título e preço
                    const tituloPreco = document.createElement("div");
                    tituloPreco.style.marginBottom = "10px";
                    tituloPreco.style.color = "#333";

                    const titulo = document.createElement("h3");
                    titulo.textContent = anuncio.descricao;
                    titulo.style.fontSize = "18px";
                    titulo.style.fontWeight = "bold";
                    titulo.style.margin = "0";
                    tituloPreco.appendChild(titulo);

                    const preco = document.createElement("p");
                    preco.textContent = `${anuncio.preco.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                    preco.style.fontSize = "16px";
                    preco.style.color = "#e74c3c";
                    preco.style.margin = "0";
                    tituloPreco.appendChild(preco);

                    li.appendChild(tituloPreco);

                    // Adicionar data e hora (se disponível)
                    if (anuncio.dataHora) {
                        const dataHora = document.createElement("p");
                        dataHora.textContent = `Data e Hora: ${new Date(anuncio.dataHora).toLocaleString('pt-BR')}`;
                        dataHora.style.fontSize = "12px";
                        dataHora.style.color = "#888";
                        dataHora.style.marginTop = "10px";
                        li.appendChild(dataHora);
                    }

                    // Botão de denunciar
                    const reportButton = document.createElement("button");
                    reportButton.innerHTML = '<i class="fas fa-flag"></i>';
                    reportButton.style.backgroundColor = "#e74c3c";
                    reportButton.style.border = "none";
                    reportButton.style.color = "#fff";
                    reportButton.style.padding = "10px";
                    reportButton.style.borderRadius = "50%";
                    reportButton.style.position = "absolute";
                    reportButton.style.top = "15px";
                    reportButton.style.right = "15px";
                    reportButton.style.cursor = "pointer";
                    reportButton.style.fontSize = "16px";
                    reportButton.onclick = () => reportPost(docId);
                    li.appendChild(reportButton);

                    // Botão de WhatsApp
                    const whatsappButton = document.createElement("button");
                    whatsappButton.innerHTML = '<i class="fab fa-whatsapp"></i>';
                    whatsappButton.style.backgroundColor = "#25D366";
                    whatsappButton.style.border = "none";
                    whatsappButton.style.color = "#fff";
                    whatsappButton.style.padding = "10px 15px";
                    whatsappButton.style.borderRadius = "50%";
                    whatsappButton.style.position = "absolute";
                    whatsappButton.style.bottom = "15px";
                    whatsappButton.style.right = "15px";
                    whatsappButton.style.cursor = "pointer";
                    whatsappButton.style.fontSize = "16px";
                    whatsappButton.onclick = () => sendWhatsAppMessage(docId);
                    li.appendChild(whatsappButton);

                    // Adicionar o li à lista de anúncios do usuário
                    userAdsList.appendChild(li);
                });
            } catch (error) {
                console.error("Erro ao carregar anúncios do usuário:", error);
            }
        }

        async function sendWhatsAppMessage(docId) {
            console.log("docId:", docId); // Verificação do docId
            try {
                // Obtém o documento do anúncio
                const docSnapshot = await getDoc(doc(db, "publicacoes", docId));
                if (!docSnapshot || !docSnapshot.exists()) {
                    console.error("Anúncio não encontrado para o docId:", docId);
                    return;
                }

                const anuncio = docSnapshot.data();
                const tituloAnuncio = anuncio.mensagem || anuncio.titulo;
                if (!tituloAnuncio) {
                    console.error("Título do anúncio não encontrado.");
                    return;
                }

                const userId = anuncio.userId; // Verifica se userId está definido
                if (!userId) {
                    console.error("userId não encontrado no anúncio.");
                    return;
                }

                const userSnapshot = await getDoc(doc(db, "users", userId));
                if (!userSnapshot.exists()) {
                    console.error("Usuário não encontrado.");
                    return;
                }

                const user = userSnapshot.data();
                const whatsappNumber = user.whatsApp;

                if (!whatsappNumber) {
                    console.error("Número de WhatsApp não encontrado.");
                    return;
                }

                const message = `Olá, vim pela plataforma MotorZapp e tenho interesse em "${tituloAnuncio}"`;
                const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
                window.open(url, '_blank');
            } catch (error) {
                console.error("Erro ao enviar mensagem no WhatsApp:", error);
            }
        }

    </script>
</body>

</html>
